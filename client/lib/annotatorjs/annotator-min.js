var __extends=__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}o.prototype=e.prototype,t.prototype=new o},ArrayUtil={contains:function(t,e){return-1!=t.indexOf(e)},getSanitized:function(t){return t.filter(function(t){return 0===t||t})},getUnique:function(t,e){if(e){var n={};return t.filter(function(t,o,i){var a=e(t);return!n.hasOwnProperty(a)&&(n[a]=!0)})}return t.filter(function(t,e,n){return n.indexOf(t)===e})},removeByIndex:function(t,e){e>-1&&t.splice(e,1)},removeByValue:function(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)},getLast:function(t){return t[t.length-1]}},StringUtil={replaceNewline:function(t){var e=String.fromCharCode(13,10);return this.replaceAll(t,"<br/>",e.toString())},replaceAll:function(t,e,n){return t.replace(new RegExp(e,"g"),n)}},ElementUtil={hasClass:function(t,e){return t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))},addClass:function(t,e){this.hasClass(t,e)||(t.className+=" "+e)},removeClass:function(t,e){if(this.hasClass(t,e)){var n=new RegExp("(\\s|^)"+e+"(\\s|$)");t.className=t.className.replace(n," ")}}};function deepEqual(t,e){return t&&e&&"object"==typeof t&&"object"==typeof e?Object.keys(t).length===Object.keys(e).length&&Object.keys(t).reduce(function(n,o){return n&&deepEqual(t[o],e[o])},!0):t===e}function clone(t){return JSON.parse(JSON.stringify(t))}function toDate(t){var e=new Date(1970,0,1);return e.setSeconds(t),e}function formatDate(t,e){let n={M:t.getMonth()+1,d:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()};return(e=e.replace(/(M+|d+|h+|m+|s+)/g,function(t){return((t.length>1?"0":"")+n[t.slice(-1)]).slice(-2)})).replace(/(y+)/g,function(e){return t.getFullYear().toString().slice(-e.length)})}var ContextMenu=function(){function t(t){this.container=t,this.menuDiv=document.createElement("div"),this.container.appendChild(this.menuDiv),this.groups=[],this.activeGroups=[],this.isMouseOverContext=!1,this.isContextOpen=!1,this.init()}return t.prototype.cleanContextMenu=function(){for(;this.menuDiv.firstChild;)this.menuDiv.removeChild(this.menuDiv.firstChild)},t.prototype.init=function(){var t=this;this.menuDiv.onmouseover=function(){t.isMouseOverContext=!0},this.menuDiv.onmouseout=function(){t.isMouseOverContext=!1},this.menuDiv.onmousedown=function(e){null==e&&(e=window.event);var n=null!=e.target?e.target:e.srcElement;n.itemValue&&n.itemValue.action&&(n.itemValue.action(),t.close())},this.menuDiv.setAttribute("class","annotatorjs-contextmenu")},t.prototype.addGroup=function(t,e,n){var o={key:t,level:0,parent:e,parentItem:n,element:document.createElement("div")};o.element.setAttribute("style","overflow-y:auto; overflow-x:hidden;"),this.groups[t]=o,e?(o.level=e.level+1,o.element.setAttribute("class","annotatorjs-contextmenu"),o.element.setAttribute("style","display: none; position: fixed; overflow-y:auto; overflow-x:hidden;"),e.element.appendChild(o.element)):(o.element.setAttribute("style","overflow-y:auto; overflow-x:hidden;"),this.menuDiv.appendChild(o.element))},t.prototype.addItem=function(t,e){var n=this,o=e?e.group.key+":"+e.label:t.group.key,i=this.groups[o];i||(this.addGroup(o,e?e.group:null,e||null),i=this.groups[o]),t.group=i,t.element=document.createElement("div"),t.element.itemValue=t,t.element.setAttribute("class","contextmenu-item"),t.element.appendChild(document.createTextNode(t.label)),t.action||(t.element.style.color="gray"),t.element.onmouseover=function(){var e=this.itemValue;Object.keys(n.groups).forEach(function(o){var i=n.groups[o];i.level>e.group.level&&(i.element.style.display="none",ElementUtil.removeClass(i.parentItem.element,"active"),t.isActive=!1)});var o=function(t){ElementUtil.addClass(t.element,"active"),t.isActive=!0,t.group.parentItem&&o(t.group.parentItem)};if(o(this.itemValue),this.itemValue.children&&this.itemValue.children.length>0){var i=n.groups[this.itemValue.group.key+":"+this.itemValue.label];i.element.style.display="block",i.element.style.left=this.getBoundingClientRect().right-0+"px",i.element.style.top=this.getBoundingClientRect().top+"px",i.element.style.maxHeight=window.innerHeight+"px",i.element.getBoundingClientRect().bottom>window.innerHeight&&(i.element.style.top=i.element.getBoundingClientRect().top-(i.element.getBoundingClientRect().bottom-window.innerHeight)+"px"),i.element.getBoundingClientRect().right>window.innerWidth&&(i.element.style.left=i.parent.element.getBoundingClientRect().left-i.element.getBoundingClientRect().width+"px")}},t.element.onmouseout=function(){ElementUtil.removeClass(t.element,"active"),t.isActive=!1},i.element.appendChild(t.element),t.children&&t.children.length>0&&(t.element.style.borderRight="4px solid gray",t.children.sort(function(t,e){return t.label>e.label?1:e.label>t.label?-1:0}),t.children.forEach(function(e){n.addItem(e,t)}))},t.prototype.setItems=function(t){this.cleanContextMenu(),this.groups=[];var e=this;t&&t.length&&t.forEach(function(t){if(t)t.group={key:t.group},e.addItem(t,null);else{var n=document.createElement("hr");n.setAttribute("style","margin:0px"),e.menuDiv.appendChild(n)}})},t.prototype.close=function(){this.isMouseOverContext=!1,this.menuDiv.style.display="none",this.afterCloseCallback&&this.afterCloseCallback()},t.prototype.show=function(t,e,n){if(this.afterCloseCallback=null,e&&e(),this.menuDiv.children.length){this.afterCloseCallback=n;document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop,document.body.scrollLeft?document.body.scrollLeft:document.documentElement.scrollLeft;this.menuDiv.style.display="block",this.menuDiv.style.left=-1e3,this.menuDiv.style.top=-1e3;var o=t.clientY+this.menuDiv.offsetHeight>window.innerHeight?window.innerHeight-this.menuDiv.offsetHeight:t.clientY,i=this,a=0,s=0;Object.keys(this.groups).forEach(function(t){var e=i.groups[t];a=e.element.offsetHeight>a?e.element.offsetHeight:a,s+=e.element.offsetHeight});for(var r=0;s>window.innerHeight-100;)Object.keys(i.groups).forEach(function(t){var e=i.groups[t];e.element.offsetHeight>=a&&(e.element.style.height=e.element.offsetHeight-50+"px",s-=50,a-=50,r+=50)});this.menuDiv.style.left=t.clientX+"px",this.menuDiv.style.top=o+r-20+"px"}else n&&n()},t}(),Dialog=function(){function t(t){this.container=t,this.dialogDiv=document.createElement("div"),this.container.appendChild(this.dialogDiv),this.isMouseOverDialog=!1,this.isDialogOpen=!1,this.init()}return t.prototype.clean=function(){for(;this.dialogDiv.firstChild;)this.dialogDiv.removeChild(this.dialogDiv.firstChild)},t.prototype.init=function(){var t=this;this.dialogDiv.onmouseover=function(){t.isMouseOverDialog=!0},this.dialogDiv.onmouseout=function(){t.isMouseOverDialog=!1},this.dialogDiv.setAttribute("class","annotatorjs-dialog"),this.dialogDiv.style["overflow-y"]},t.prototype.close=function(){this.isMouseOverDialog=!1,this.dialogDiv.style.display="none",this.afterCloseCallback&&this.afterCloseCallback()},t.prototype.show=function(t,e,n,o){this.clean();var i=this;if(e.forEach(function(t){i.dialogDiv.appendChild(t)}),this.afterCloseCallback=null,n&&n(),this.dialogDiv.children.length){this.afterCloseCallback=o;document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop,document.body.scrollLeft?document.body.scrollLeft:document.documentElement.scrollLeft;this.dialogDiv.style.display="block",this.dialogDiv.style.left=-1e3,this.dialogDiv.style.top=-1e3;for(var a=t.clientY+this.dialogDiv.offsetHeight>window.innerHeight?window.innerHeight-this.dialogDiv.offsetHeight:t.clientY,s=(i=this,0),r=0,l=0;r>window.innerHeight-100;)Object.keys(i.groups).forEach(function(t){var e=i.groups[t];e.offsetHeight>=s&&(e.style.height=e.offsetHeight-50+"px",r-=50,s-=50,l+=50)});this.dialogDiv.style.left=t.clientX-this.dialogDiv.offsetWidth-50+"px",this.dialogDiv.style.top=a+l-20+"px"}else o&&o()},t}(),SVG_NS="http://www.w3.org/2000/svg",Arc=function(){function t(t){this.documentAnnotator=t,this.svgElement=document.createElementNS(SVG_NS,"path"),this.svgElement.setAttribute("fill","none"),this.toDefaultState()}return t.prototype.hide=function(){this.toDefaultState(),this.setPosition({x:0,y:0},{x:0,y:0})},t.prototype.setPosition=function(t,e){var n=t.x+","+t.y,o=Math.abs(t.x-e.x),i=(t.x>e.x?t.x-o/2:t.x+o/2)+","+(Math.min(t.y,e.y)-70),a=e.x+","+e.y;this.svgElement.setAttribute("d","M"+n+" Q"+i+" "+a)},t.prototype.toDefaultState=function(){this.svgElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.relation.arc.color.fill),this.svgElement.setAttribute("marker-end","url(#arrowMarker)"),this.svgElement.setAttribute("stroke-width",1)},t.prototype.toValidState=function(){this.svgElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.relation.arc.color.valid),this.svgElement.setAttribute("marker-end","url(#arrowValidMarker)"),this.svgElement.setAttribute("stroke-width",2)},t.prototype.toInvalidState=function(){this.svgElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.relation.arc.color.invalid),this.svgElement.setAttribute("marker-end","url(#arrowInvalidMarker)"),this.svgElement.setAttribute("stroke-width",2)},t}(),Connector=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o,i,a){this.documentAnnotator=t,this.sentence=e,this.input=n,this.tokens=o;var s=parseInt(this.input.split(":")[0]),r=parseInt(i.sentence.key),l=i.mirrorRelation?parseInt(i.mirrorRelation.sentence.key):null;s!=r&&i.mirrorRelation&&(s==l||r>l)?this.relation=i.mirrorRelation:this.relation=i,this.collaborator=a,this.startY=0,this.startX=0,this.width=0,this.height=0,this.refreshKey(),this.svgElement=document.createElementNS(SVG_NS,"g"),this.svgElement.setAttribute("key",this.key),this.svgElement.annotatorElement=this;var c=this,h=function(t){t.annotatorElement=c,c.svgElement.appendChild(t),t.mouseOverHandler=function(){this.annotatorElement.highlightOn(),this.annotatorElement.highlightChainOn()},t.mouseOutHandler=function(){this.annotatorElement.highlightOff(),this.annotatorElement.highlightChainOff()},t.setAttribute("onmouseover","this.mouseOverHandler();"),t.setAttribute("onmouseout","this.mouseOutHandler();")};this.arcElement=document.createElementNS(SVG_NS,"polyline"),this.arcElement.setAttribute("stroke-dasharray","5,5"),this.arcElement.setAttribute("fill","none"),h(this.arcElement),this.tokensBackgroundElement=document.createElementNS(SVG_NS,"rect"),this.tokensBackgroundElement.setAttribute("height",this.documentAnnotator.annotator.config.style.token.font.size+this.documentAnnotator.annotator.config.style.margin.default),this.tokensBackgroundElement.setAttribute("stroke","#ffffff"),this.tokensBackgroundElement.setAttribute("stroke-width",2),this.tokensBackgroundElement.setAttribute("fill-opacity",this.documentAnnotator.annotator.config.style.opacity.default),this.tokensBackgroundElement.setAttribute("class","annotatorjs-pointable"),h(this.tokensBackgroundElement),this.enableHighlightHandler(),this.highlightOff(),this.refreshColor()}return t.prototype.refreshKey=function(){this.simpleKey=this.relation.simpleKey+":"+this.input,this.key=this.simpleKey,this.collaborator&&(this.key=this.collaborator+":"+this.key)},t.prototype.refreshColor=function(){var t=this.documentAnnotator.annotator.config.style.color.primary.default;"active"==this.state?t=this.documentAnnotator.annotator.config.style.color.primary.active:"inactive"==this.state&&(t=this.documentAnnotator.annotator.config.style.color.primary.inactive),this.tokensBackgroundElement.setAttribute("fill",t)},t.prototype.active=function(){this.state="active",this.refreshColor()},t.prototype.inactive=function(){this.state="inactive",this.refreshColor()},t.prototype.enableHighlightHandler=function(){this.enabledHighlightHandler=!0},t.prototype.disableHighlightHandler=function(){this.enabledHighlightHandler=!1},t.prototype.highlightOn=function(){this.enabledHighlightHandler&&(this.arcElement.setAttribute("stroke-width",1.5),this.arcElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.connector.arc.color.highlight),this.arcElement.setAttribute("marker-end","url(#arrowHoverMarker)"),this.tokensBackgroundElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.color.primary.highlight))},t.prototype.highlightOff=function(){this.enabledHighlightHandler&&(this.arcElement.setAttribute("stroke-width",1),this.arcElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.connector.arc.color.fill),this.arcElement.setAttribute("marker-end","url(#arrowMarker)"),this.refreshColor())},t.prototype.highlightChainOn=function(){if(this.enabledHighlightHandler){this.relation.highlightOn(),this.relation.toTag.highlightOn(),this.relation.fromTag.highlightOn();for(var t=0;t<this.tokens.length;t++)this.tokens[t].highlightOn()}},t.prototype.highlightChainOff=function(){if(this.enabledHighlightHandler){this.relation.highlightOff(),this.relation.toTag.highlightOff(),this.relation.fromTag.highlightOff();for(var t=0;t<this.tokens.length;t++)this.tokens[t].highlightOff()}},t.prototype.refreshElementPosition=function(){var t=this.tokens[0],e=this.tokens[this.tokens.length-1],n=Math.abs(t.getX()-e.getX())+e.getLength(),o=(Math.abs(this.relation.startY-e.getY()),this.documentAnnotator.annotator.config.style.token.font.size,t.getX()+n/2),i=t.getY()-this.documentAnnotator.annotator.config.style.token.font.size,a=this.relation,s=o+","+i;s+=" "+(parseFloat(a.textBackgroundElement.getAttribute("x"))+parseFloat(a.textBackgroundElement.getAttribute("width"))/2)+","+(parseFloat(a.textBackgroundElement.getAttribute("y"))+12),this.arcElement.setAttribute("points",s),this.tokensBackgroundElement.setAttribute("x",t.getX()),this.tokensBackgroundElement.setAttribute("y",i),this.tokensBackgroundElement.setAttribute("width",n)},t.prototype.hide=function(){this.arcElement.setAttribute("points",""),this.tokensBackgroundElement.setAttribute("x",-1e5),this.tokensBackgroundElement.setAttribute("y",-1e5)},t}()),DocumentHeader=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o){var i=this;this.documentAnnotator=t,this.availableStatus=e||[],this.indexLabel=n,this.onChange=o,this.documentAnnotator.annotator.isInViewMode()&&this.createLogView(),this.container=document.createElement("div"),t.container.insertBefore(this.container,t.container.firstChild),this.container.style["background-color"]=this.documentAnnotator.annotator.config.style.header.color.background,this.container.style["font-size"]=this.documentAnnotator.annotator.config.style.header.font.size+"px",this.metadata=t.doc.metadata,this.metadataTexts=[],this.indexContainer=document.createElement("div"),this.documentAnnotator.annotator.config.showIndex&&(this.container.appendChild(this.indexContainer),this.indexContainer.style.float="left",this.indexContainer.style["text-align"]="center",this.indexContainer.style["background-color"]="#424546",this.indexContainer.style.color="#FFFFFF",this.indexContainer.style.width=this.documentAnnotator.annotator.config.style.sentence.index.width+"px",this.indexContainer.appendChild(document.createTextNode("#"+(void 0==n?"":n)))),this.headerBodyContainer=document.createElement("div"),this.container.appendChild(this.headerBodyContainer),this.headerBodyContainer.style.float="left";var a=this.documentAnnotator.annotator.config.showIndex?"calc(100% - "+this.documentAnnotator.annotator.config.style.sentence.index.width+"px)":"100%";this.headerBodyContainer.style.width=a,this.metadataContainer=document.createElement("div"),this.documentAnnotator.annotator.config.showMetadata&&(this.headerBodyContainer.appendChild(this.metadataContainer),this.metadataContainer.style.padding="5px",this.metadata&&Object.keys(this.metadata).forEach(function(t){if(t){var e=document.createElement("div");i.metadataContainer.appendChild(e);var n=document.createElement("span");n.style["font-weight"]="bold",n.style["margin-right"]="5px",n.style.color="#000000",n.appendChild(document.createTextNode(t+":")),e.appendChild(n);var o=document.createElement("span");o.style.color="#000000",o.appendChild(document.createTextNode(i.metadata[t])),e.appendChild(o)}})),this.statusContainer=document.createElement("div"),this.headerBodyContainer.appendChild(this.statusContainer),this.statusContainer.style.float="right",this.statusContainer.style.padding="5px",this.statusButtons=[];for(var s=0;s<this.availableStatus.length;s++){var r=this.availableStatus[s];if(!this.statusButtons[r]){var l=document.createElement("div");this.statusContainer.appendChild(l),l.statusValue=r,l.style.float="left",l.style.padding="4px",l.style.margin="1px",l.setAttribute("class","annotatorjs-pointable annotatorjs-unselectable"),this.documentAnnotator.annotator.isInViewMode()||this.documentAnnotator.annotator.isReadOnly()||(l.onclick=function(){var t=i.documentAnnotator.doc.status,e=this.statusValue;t!=e&&(log={action:"CHANGE",firedBy:"DEFAULT",subject:{type:"STATUS",value:{old:t,new:e}},dependencies:[]},i.updateStatus(e),i.onChange&&i.onChange(log))}),l.appendChild(document.createTextNode(r)),this.statusButtons[r]=l}}var c=function(t,e){var n=document.createElement("div");return n.style.float="left",n.style.padding="4px",n.style.margin="1px",n.setAttribute("class","annotatorjs-pointable annotatorjs-unselectable"),n.onclick=t,n.innerHTML=e,n.style.color=i.documentAnnotator.annotator.config.style.header.color.action,n.style["background-color"]=i.documentAnnotator.annotator.config.style.header.color.actionBackground.enabled,n.style["font-size"]=i.documentAnnotator.annotator.config.style.header.font.size+"px",n},h=[];this.documentAnnotator.annotator.isInViewMode()||this.documentAnnotator.annotator.isReadOnly()||(h.push({key:"UNDO",label:"&#8617; Undo",onclick:function(){i.documentAnnotator.undo(!1,!0,!0)}}),h.push({key:"REDO",label:"&#8618; Redo",onclick:function(){i.documentAnnotator.redo()}})),this.documentAnnotator.annotator.isInValidationMode()&&!this.documentAnnotator.annotator.isReadOnly()&&h.push({key:"AUTOMATCH",label:"&#8803; Auto Match",onclick:function(){i.documentAnnotator.autoMatch()}}),this.documentAnnotator.annotator.config.showComments&&(this.documentAnnotator.annotator.isInAnnotationMode()||this.documentAnnotator.annotator.isInViewMode()||this.documentAnnotator.annotator.isInValidationMode())&&h.push({key:"COMMENTS",label:"Comments",onclick:function(t){var e=[];if(i.documentAnnotator.annotator.isInAnnotationMode()||i.documentAnnotator.annotator.isInViewMode()){var n=document.createElement("textarea");if(n.style.float="left",n.style.width="500px",n.style["font-size"]=i.documentAnnotator.annotator.config.style.header.font.size+"px",n.value=i.documentAnnotator.doc.comments,e.push(n),e.push(document.createElement("br")),i.documentAnnotator.annotator.isInAnnotationMode()&&!i.documentAnnotator.annotator.isReadOnly()){var o=c(function(){i.documentAnnotator.changeComments(n.value),i.documentAnnotator.annotator.dialog.close()},"Save");e.push(o);var a=c(function(){i.documentAnnotator.annotator.dialog.close()},"Cancel");e.push(a),n.style.height="100px"}else n.style.height="120px",n.setAttribute("readonly","true")}else{var s=document.createElement("div");s.style.overflow="auto",s.style.width="500px",s.style["max-height"]="200px",i.documentAnnotator.doc.collaborations.forEach(function(t){var e=document.createElement("div"),n="<strong>"+t.collaborator.email;n+=", "+t.collaborator.firstName,n+=" "+t.collaborator.lastName+"</strong>",e.innerHTML=n,s.appendChild(e);var o=document.createElement("div");o.innerHTML="<pre>"+t.comments+"</pre>",s.appendChild(o)}),e.push(s)}i.documentAnnotator.annotator.dialog.show(t,e,function(){i.documentAnnotator.annotator.preventKeyEvents=!0},function(){i.documentAnnotator.annotator.preventKeyEvents=!1})}}),this.actionContainer=document.createElement("div"),this.headerBodyContainer.appendChild(this.actionContainer),this.actionContainer.style.float="right",this.actionContainer.style.padding="5px",this.actionButtons=[];for(s=0;s<h.length;s++){var g=h[s];l=c(g.onclick,g.label);this.actionContainer.appendChild(l),this.actionButtons[g.key]=l}this.height=Math.max(this.indexContainer.offsetHeight,this.metadataContainer.offsetHeight,this.statusContainer.offsetHeight,this.actionContainer.offsetHeight),this.documentAnnotator.annotator.config.showMetadata&&(this.height+=30),this.documentAnnotator.annotator.isInViewMode()&&(this.height+=10),this.container.style.height=this.height+"px",this.documentAnnotator.annotator.config.showIndex&&(this.indexContainer.style["line-height"]=this.height+"px"),this.documentAnnotator.annotator.config.showMetadata,this.updateStatus(this.documentAnnotator.doc.status)}return t.prototype.createLogView=function(){this.logDivs=[];var t=this;this.logContainer=document.createElement("div"),this.logContainer.style["font-size"]=t.documentAnnotator.annotator.config.style.header.font.size+"px",this.documentAnnotator.container.insertBefore(this.logContainer,this.documentAnnotator.container.firstChild),this.logContainer.style.height="100px",this.logContainer.style.overflow="auto",this.logContainer.style.border="2px solid #A9A9A9";for(var e=function(e,n){n||t.documentAnnotator.clean();for(var o=0;o<t.logDivs.length;o++){var i=t.logDivs[o];o<=e.index?(i.markerDiv.style.width="10px",i.markerDiv.style.margin="0px 7px 0px 8px",i.markerDiv.style["background-color"]="#138713",i.textDiv.style["background-color"]="#EAEAEA",n||t.documentAnnotator.applyAction(i.log)):(i.markerDiv.style.width="5px",i.markerDiv.style.margin="0px 10px 0px 10px",i.markerDiv.style["background-color"]="#AFAFAF",i.textDiv.style["background-color"]="#F9F9F9")}t.documentAnnotator.annotator.updateSize(),t.appliedLog=e},n=0;n<this.documentAnnotator.doc.logs.length;n++){var o=this.documentAnnotator.doc.logs[n],i=document.createElement("div");i.index=n,i.log=o,i.setAttribute("class","annotatorjs-pointable annotatorjs-unselectable"),i.style.height="32px",i.onclick=function(){e(this)};var a=document.createElement("div");a.style.height="32px",a.style.float="left",i.appendChild(a),i.markerDiv=a;var s=document.createElement("div");s.style.height="18px",s.style.float="left",s.style.padding="5px",s.style.margin="2px 0px 2px 0px",s.style.width="calc(100% - 50px)",s.style.color="#000000",s.style["box-sizing"]="content-box";var r="",l=function(t){var e=t.action;return t.subject&&t.subject.type&&(e+=" "+t.subject.type),e},c=function(t){if(t.subject&&t.subject.type)switch(t.subject.type){case"TAG":var e=t.subject.value.range.split(":").map(function(t){return parseInt(t)});return t.subject.value.label+" "+(e[0]+1)+":"+e[1]+":"+e[2];case"RELATION":var n=t.subject.value.from.range.split(":").map(function(t){return parseInt(t)}),o=t.subject.value.to.range.split(":").map(function(t){return parseInt(t)}),i=t.subject.value.from.label+" "+(n[0]+1)+":"+n[1]+":"+n[2],a=t.subject.value.to.label+" "+(o[0]+1)+":"+o[1]+":"+o[2];return i+" "+t.subject.value.label+" "+a;case"CONNECTOR":e=t.subject.value.range.split(":").map(function(t){return parseInt(t)});return t.subject.value.label+" "+(e[0]+1)+":"+e[1]+":"+e[2];case"RANGE":return(e=t.subject.value.range.split(":").map(function(t){return parseInt(t)}))[0]+1+":"+e[1]+":"+e[2];case"STATUS":return t.subject.value.old+" to "+t.subject.value.new}},h=l(o),g=c(o);"ADD"==o.action?r+='<span style="color:green"><strong>'+h+": </strong></span>":"REMOVE"==o.action?r+='<span style="color:red"><strong>'+h+": </strong></span>":"UNDO"==o.action||"REDO"==o.action?(r+='<span style="color:blue"><strong>'+h+": </strong></span>","ADD"==o.subject.action?r+='<span style="color:green"><strong>'+l(o.subject)+": </strong></span>":"REMOVE"==o.subject.action&&(r+='<span style="color:red"><strong>'+l(o.subject)+": </strong></span>")):r+='<span style="color:blue"><strong>'+h+": </strong></span>",g?r+="<strong>"+g+"</strong>":"UNDO"!=o.action&&"REDO"!=o.action||(r+="<strong>"+c(o.subject)+"</strong>"),"SHORTCUT"==o.firedBy&&(r+=" (using shortcut)");var u=toDate(o.atTime);u.setMinutes(u.getMinutes()-u.getTimezoneOffset()),r+=" at "+formatDate(u,"dd/MM/yyyy hh:mm:ss"),s.innerHTML=r,i.appendChild(s),i.textDiv=s,this.logContainer.appendChild(i),this.logDivs.push(i)}e(this.logDivs[this.logDivs.length-1],!0)},t.prototype.updateStatus=function(t){this.documentAnnotator.doc.status=t,this.checkButtonsState()},t.prototype.checkButtonsState=function(){var t=this;Object.keys(this.statusButtons).forEach(function(e){var n=t.statusButtons[e];e==t.documentAnnotator.doc.status?(n.style["background-color"]=t.documentAnnotator.annotator.config.style.color.success.default,n.style.color="#FFFFFF"):(n.style["background-color"]=t.documentAnnotator.annotator.config.style.sentence.color.background.even,n.style.color="#000000")}),Object.keys(this.actionButtons).forEach(function(e){var n=t.actionButtons[e],o=!0;"UNDO"==e?o=!!t.documentAnnotator.getActionToUndo():"REDO"==e&&(o=!!t.documentAnnotator.getActionToRedo()),n.style.color=t.documentAnnotator.annotator.config.style.header.color.action,n.style["background-color"]=o?t.documentAnnotator.annotator.config.style.header.color.actionBackground.enabled:t.documentAnnotator.annotator.config.style.header.color.actionBackground.disabled})},t.prototype.refresh=function(){},t}()),Relation=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o,i,a,s){this.documentAnnotator=t,this.sentence=e,this.input=n,this.fromTag=o,this.toTag=i,this.mirrorRelation=a,this.collaborator=s,this.startY=0,this.startX=0,this.width=0,this.height=0,this.connectors=[],this.refreshKey(),this.refreshTags(),this.svgElement=document.createElementNS(SVG_NS,"g"),this.svgElement.setAttribute("key",this.key),this.svgElement.annotatorElement=this,this.arcElement=document.createElementNS(SVG_NS,"polyline"),this.arcElement.setAttribute("fill","none"),this.postInitElement(this.arcElement),this.textBackgroundElement=document.createElementNS(SVG_NS,"rect"),this.textBackgroundElement.setAttribute("fill-opacity",this.documentAnnotator.annotator.config.style.opacity.default),this.textBackgroundElement.setAttribute("class","annotatorjs-pointable"),this.textBackgroundElement.setAttribute("height",this.documentAnnotator.annotator.config.style.relation.text.font.size),this.postInitElement(this.textBackgroundElement),this.refreshText(),this.refreshColor(),this.enableHighlightHandler(),this.highlightOff()}return t.prototype.addConnector=function(t){this.connectors.push(t)},t.prototype.removeConnector=function(t){ArrayUtil.removeByValue(this.connectors,t)},t.prototype.postInitElement=function(t){t.annotatorElement=this,this.svgElement.appendChild(t),t.mouseOverHandler=function(){this.annotatorElement.highlightOn(),this.annotatorElement.highlightChainOn()},t.mouseOutHandler=function(){this.annotatorElement.highlightOff(),this.annotatorElement.highlightChainOff()},t.setAttribute("onmouseover","this.mouseOverHandler();"),t.setAttribute("onmouseout","this.mouseOutHandler();")},t.prototype.refreshKey=function(){this.simpleKey=this.fromTag.input.range+":"+this.fromTag.input.label+":"+this.toTag.input.range+":"+this.toTag.input.label+":"+this.input.label,this.key=this.simpleKey,this.collaborator&&(this.key=this.collaborator+":"+this.key)},t.prototype.refreshColor=function(){var t=this.documentAnnotator.annotator.config.style.color.primary.default,e=this.documentAnnotator.annotator.config.style.font.color.default;"active"==this.state?(t=this.documentAnnotator.annotator.config.style.color.primary.active,e=this.documentAnnotator.annotator.config.style.font.color.active):"inactive"==this.state&&(t=this.documentAnnotator.annotator.config.style.color.primary.inactive,e=this.documentAnnotator.annotator.config.style.font.color.inactive),this.textBackgroundElement.setAttribute("fill",t),this.textElement.setAttribute("fill",e)},t.prototype.active=function(){this.state="active",this.refreshColor()},t.prototype.inactive=function(){this.state="inactive",this.refreshColor()},t.prototype.refreshTags=function(){var t=this.fromTag.input.range.split(":"),e=this.toTag.input.range.split(":");this.isFromTopRelation=this.sentence.key==t[0]?parseInt(t[0])>parseInt(e[0]):parseInt(t[0])<parseInt(e[0]),this.isFromBottomRelation=this.sentence.key==t[0]?parseInt(t[0])<parseInt(e[0]):parseInt(t[0])>parseInt(e[0]),this.isFromTopRelation||this.isFromBottomRelation?this.sentence.key==t[0]?(this.startMarkerUrl="url(#circleMarker)",this.startMarkerHoverUrl="url(#circleHoverMarker)"):(this.startMarkerUrl="url(#circleMarker)",this.startMarkerHoverUrl="url(#circleHoverMarker)",this.endMarkerUrl="url(#arrowMarker)",this.endMarkerHoverUrl="url(#arrowHoverMarker)"):(this.endMarkerUrl="url(#arrowMarker)",this.endMarkerHoverUrl="url(#arrowHoverMarker)")},t.prototype.refreshText=function(){this.textElement&&this.svgElement.removeChild(this.textElement);var t=this.fromTag.input.range.split(":"),e=this.toTag.input.range.split(":");this.textElement=document.createElementNS(SVG_NS,"text"),this.textElement.setAttribute("class","annotatorjs-pointable annotatorjs-unselectable"),this.textElement.setAttribute("font-weight","normal"),this.textElement.setAttribute("style","font-size:"+this.documentAnnotator.annotator.config.style.relation.text.font.size+"px");if(this.isFromTopRelation||this.isFromBottomRelation){var n=parseInt(t[0])<parseInt(e[0])?"&#9660; "+this.input.label:"&#9650; "+this.input.label,o=(this.sentence.key!=t[0]?this.fromTag:this.toTag).input.range.split(":");n+=" "+(parseInt(o[0])+1)+"["+o[1]+":"+o[2]+"]"}else n=parseInt(t[1])<parseInt(e[1])?this.input.label+" &#9658;":"&#9668; "+this.input.label;this.textElement.innerHTML=n,this.postInitElement(this.textElement)},t.prototype.enableHighlightHandler=function(){this.enabledHighlightHandler=!0},t.prototype.disableHighlightHandler=function(){this.enabledHighlightHandler=!1},t.prototype.highlightOn=function(){this.enabledHighlightHandler&&(this.arcElement.setAttribute("stroke-width",1.5),this.arcElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.relation.arc.color.highlight),this.arcElement.setAttribute("marker-start",this.startMarkerHoverUrl),this.textElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.font.color.highlight),this.textBackgroundElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.color.primary.highlight))},t.prototype.highlightOff=function(){this.enabledHighlightHandler&&(this.arcElement.setAttribute("stroke-width",1),this.arcElement.setAttribute("stroke",this.documentAnnotator.annotator.config.style.relation.arc.color.fill),this.arcElement.setAttribute("marker-start",this.startMarkerUrl),this.refreshColor())},t.prototype.highlightChainOn=function(){this.enabledHighlightHandler&&(this.fromTag.highlightOn(),this.toTag.highlightOn(),this.mirrorRelation&&this.mirrorRelation.highlightOn())},t.prototype.highlightChainOff=function(){this.enabledHighlightHandler&&(this.fromTag.highlightOff(),this.toTag.highlightOff(),this.mirrorRelation&&this.mirrorRelation.highlightOff())},t.prototype.shiftElementPosition=function(t){this.startY+=t,this.refreshElementPosition()},t.prototype.refreshElementPosition=function(){this.width=this.textElement.getComputedTextLength();var t="",e=this.fromTag.sentence.key==this.sentence.key?this.fromTag.startX+this.fromTag.width/2:this.toTag.startX+this.toTag.width/2,n=-this.width/2;if(this.isFromTopRelation)t=e+","+this.startY,t+=" "+e+","+(this.startY+this.height),n+=e;else if(this.isFromBottomRelation)t=e+","+(this.startY+this.height),t+=" "+e+","+this.startY,n+=e;else{var o,i;this.fromTag.startX<this.toTag.startX?(o=this.fromTag.startX+this.fromTag.width,i=this.toTag.startX):(o=this.fromTag.startX,i=this.toTag.startX+this.toTag.width),t=o+","+(this.startY+this.height),t+=" "+(o>i?o-10:o+10)+","+this.startY,t+=" "+(o<i?i-10:i+10)+","+this.startY,t+=" "+i+","+(this.startY+this.height),n+=Math.min(o,i)+Math.abs(o-i)/2,this.width=Math.max(this.width,Math.abs(o-i))}this.arcElement.setAttribute("points",t);var a=this.startY-this.documentAnnotator.annotator.config.style.relation.text.font.size/2;(this.isFromTopRelation||this.isFromBottomRelation)&&(a+=this.documentAnnotator.annotator.config.style.padding.interrelation/2),this.textBackgroundElement.setAttribute("x",n),this.textBackgroundElement.setAttribute("y",a),this.textBackgroundElement.setAttribute("width",this.textElement.getComputedTextLength()),this.textElement.setAttribute("x",n),this.textElement.setAttribute("y",a+this.documentAnnotator.annotator.config.style.relation.text.font.size-2)},t.prototype.hide=function(){this.textBackgroundElement.setAttribute("x",-1e5),this.textElement.setAttribute("x",-1e5),this.textBackgroundElement.setAttribute("x",-1e5),this.arcElement.setAttribute("points",""),this.textBackgroundElement.setAttribute("y",-1e5),this.textElement.setAttribute("y",-1e5),this.textBackgroundElement.setAttribute("y",-1e5)},t}()),Sentence=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o){this.documentAnnotator=t,this.key=e,this.minWidth=t.annotatorContainer.offsetWidth,this.width=0,this.height=0,this.expanded=!1,this.hasDifference=!1,this.canToggle=n,this.svgElement=document.createElementNS(SVG_NS,"g"),this.svgElement.setAttribute("key",this.key),this.svgElement.annotatorElement=this,t.svgElement.appendChild(this.svgElement),this.sentenceBackground=document.createElementNS(SVG_NS,"rect"),this.sentenceBackground.setAttribute("x",0),this.sentenceBackground.setAttribute("fill",e%2==0?this.documentAnnotator.annotator.config.style.sentence.color.background.even:this.documentAnnotator.annotator.config.style.sentence.color.background.odd),this.sentenceBackground.annotatorElement=this,this.svgElement.appendChild(this.sentenceBackground),this.connectors=[],this.connectorsElement=document.createElementNS(SVG_NS,"g"),this.connectorsElement.annotatorElement=this,this.svgElement.appendChild(this.connectorsElement),this.tags=[],this.tagsElement=document.createElementNS(SVG_NS,"g"),this.tagsElement.annotatorElement=this,this.svgElement.appendChild(this.tagsElement),this.relations=[],this.relationsElement=document.createElementNS(SVG_NS,"g"),this.relationsElement.annotatorElement=this,this.svgElement.appendChild(this.relationsElement),this.tokens=[],this.sentenceTextElement=document.createElementNS(SVG_NS,"g"),this.sentenceTextElement.annotatorElement=this,this.svgElement.appendChild(this.sentenceTextElement),this.mainSentenceText=document.createElementNS(SVG_NS,"text"),this.mainSentenceText.annotatorElement=this,this.sentenceTextElement.appendChild(this.mainSentenceText),this.secondarySentenceTexts=[],this.collaboratorTexts=[],this.collaboratorTextElement=document.createElementNS(SVG_NS,"g"),this.collaboratorTextElement.annotatorElement=this,this.svgElement.appendChild(this.collaboratorTextElement),this.collaboratorSeparators=[],this.collaboratorSeparatorElement=document.createElementNS(SVG_NS,"g"),this.collaboratorSeparatorElement.annotatorElement=this,this.svgElement.appendChild(this.collaboratorSeparatorElement),this.sentenceIndexBackground=document.createElementNS(SVG_NS,"rect"),this.sentenceIndexBackground.setAttribute("fill",this.documentAnnotator.annotator.config.style.sentence.index.color.background),this.sentenceIndexBackground.setAttribute("fill-opacity",.9),this.sentenceIndexBackground.setAttribute("width",this.documentAnnotator.annotator.config.style.sentence.index.width),this.sentenceIndexBackground.setAttribute("stroke","#ffffff"),this.sentenceIndexBackground.setAttribute("stroke-width","2");var i=this;this.canToggle&&(this.sentenceIndexBackground.setAttribute("class","annotatorjs-pointable"),this.sentenceIndexBackground.onclick=function(){i.expanded=!i.expanded,o(i)}),this.sentenceIndexBackground.annotatorElement=this,this.svgElement.appendChild(this.sentenceIndexBackground),this.sentenceIndexText=document.createElementNS(SVG_NS,"text"),this.sentenceIndexText.setAttribute("text-anchor","middle"),this.sentenceIndexText.style["font-size"]=this.documentAnnotator.annotator.config.style.sentence.index.font.size+"px",this.sentenceIndexText.appendChild(document.createTextNode(this.key+1)),this.sentenceIndexText.annotatorElement=this,this.svgElement.appendChild(this.sentenceIndexText),this.setSentenceIndexX(0)}return t.prototype.checkDifferences=function(){var t=this.getAllCollaborators(),e=this,n=function(n){var o=Object.keys(n),i=[];if(n==e.tags)for(var a=0;a<o.length;a++){var s=e.tags[o[a]];i.push(o[a]+":"+s.input.label)}var r=!1,l=[];for(a=0;a<o.length;a++){var c=n[o[a]];if(c.collaborator){var h=c.simpleKey;n==e.tags&&(h=c.simpleKey+":"+c.input.label),l[h]?l[h]+=1:l[h]=1}}var g=Object.keys(l);for(a=0;a<g.length;a++){var u=l[g[a]];if(t.length-1!=u){r=!0;break}}return r};this.hasDifference=n(this.tokens),this.hasDifference||(this.hasDifference=n(this.tags)),this.hasDifference||(this.hasDifference=n(this.relations)),this.hasDifference||(this.hasDifference=n(this.connectors)),this.hasDifference?this.sentenceIndexBackground.setAttribute("fill",this.documentAnnotator.annotator.config.style.sentence.index.color.diffBackground):this.sentenceIndexBackground.setAttribute("fill",this.documentAnnotator.annotator.config.style.sentence.index.color.background)},t.prototype.updateElementsState=function(){for(var t=function(t){return Object.keys(t).filter(function(t){return-1==t.split(":")[0].indexOf(",")})},e=(t(this.tags),t(this.relations),t(this.connectors),function(t,e,n){t.forEach(function(t){var e=n[t.simpleKey];e&&e.input.label==t.input.label?t.active():t.inactive()})}),n=this.getAllCollaborators(),o=0;o<n.length;o++){var i=n[o];if(i)e(this.getElements(this.tags,i),0,this.tags),e(this.getElements(this.relations,i),0,this.relations),e(this.getElements(this.connectors,i),0,this.connectors)}},t.prototype.getSentenceText=function(t){if(t){var e=this.secondarySentenceTexts[t];return e||((e=document.createElementNS(SVG_NS,"text")).annotatorElement=this,this.sentenceTextElement.appendChild(e),this.secondarySentenceTexts[t]=e),e}return this.mainSentenceText},t.prototype.setSentenceIndexX=function(t){this.sentenceIndexBackground.setAttribute("x",t),this.sentenceIndexText.setAttribute("x",t+this.documentAnnotator.annotator.config.style.sentence.index.width/2);for(var e=Object.keys(this.collaboratorTexts),n=0;n<e.length;n++){this.collaboratorTexts[e[n]].setAttribute("x",t+this.documentAnnotator.annotator.config.style.sentence.index.width+5)}},t.prototype.getStartY=function(){return this.startY},t.prototype.setStartY=function(t){this.startY=t},t.prototype.getToken=function(t){return this.tokens[t]},t.prototype.addToken=function(t){this.tokens[t.key]=t,this.getSentenceText(t.collaborator).appendChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.getTag=function(t){return this.tags[t]},t.prototype.addTag=function(t){this.tags[t.key]=t,this.tagsElement.appendChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.removeTag=function(t){delete this.tags[t.key],this.tagsElement.removeChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.getRelation=function(t){return this.relations[t]},t.prototype.addRelation=function(t){this.relations[t.key]=t,this.relationsElement.appendChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.removeRelation=function(t){delete this.relations[t.key],this.relationsElement.removeChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.getConnector=function(t){return this.connectors[t]},t.prototype.addConnector=function(t){this.connectors[t.key]=t,this.connectorsElement.appendChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.removeConnector=function(t){delete this.connectors[t.key],this.connectorsElement.removeChild(t.svgElement),this.documentAnnotator.annotator.isInValidationMode()&&this.checkDifferences()},t.prototype.getElementKeys=function(t,e){return Object.keys(t).filter(function(t){return e?t.split(":")[0]==e:-1==t.split(":")[0].indexOf(",")})},t.prototype.getElements=function(t,e){return Object.keys(t).map(function(n){var o=t[n];if(o.collaborator==e)return o}).filter(function(t){return!!t})},t.prototype.getRelationLevelMap=function(t){var e=1,n=[],o=[];this.getElementKeys(this.tokens,t).forEach(function(t){n[t]=0});for(var i=this.getElementKeys(this.relations,t).sort(function(e,n){var o=t?1:0,i=e.split(":"),a=n.split(":");return Math.abs(parseInt(i[5+o])-parseInt(i[1+o]))-Math.abs(parseInt(a[5+o])-parseInt(a[1+o]))}),a=0;a<i.length;a++){var s=this.relations[i[a]],r=s.input.from.range.split(":"),l=s.input.to.range.split(":"),c=parseInt(r[0]);if(c==parseInt(l[0])){for(var h=parseInt(r[1]),g=parseInt(l[1]),u=Math.min(h,g),d=Math.max(h,g),f=1,m=u;m<d;m++){n[p=c+":"+m]&&(f=Math.max(f,n[p]+1),e=Math.max(e,f))}for(m=u;m<d;m++){var p;n[p=c+":"+m]=f}o[i[a]]=f}}return o},t.prototype.shiftElementPosition=function(t){this.startY+=t;for(var e=this.getAllCollaborators(),n=0;n<e.length;n++){var o=e[n];if(!o||o&&this.expanded){for(var i=this.getElementKeys(this.tokens,o),a=0;a<i.length;a++){this.tokens[i[a]].shiftElementPosition(t)}var s=this.getElementKeys(this.tags,o);for(a=0;a<s.length;a++){this.tags[s[a]].shiftElementPosition(t)}var r=this.getElementKeys(this.relations,o);for(a=0;a<r.length;a++){this.relations[r[a]].shiftElementPosition(t)}var l=this.getElementKeys(this.connectors,o);for(a=0;a<l.length;a++){this.connectors[l[a]].refreshElementPosition()}var c=Object.keys(this.collaboratorTexts);for(n=0;n<c.length;n++){var h=this.collaboratorTexts[c[n]];h.setAttribute("y",parseFloat(h.getAttribute("y"))+t)}var g=Object.keys(this.collaboratorSeparators);for(n=0;n<g.length;n++){var u=this.collaboratorSeparators[g[n]];u.setAttribute("y1",parseFloat(u.getAttribute("y1"))+t),u.setAttribute("y2",parseFloat(u.getAttribute("y2"))+t)}}}this.updateBackground()},t.prototype.getAllCollaborators=function(){for(var t=[],e=Object.keys(this.tokens),n=0;n<e.length;n++){var o=this.tokens[e[n]];o.collaborator&&-1==t.indexOf(o.collaborator)&&t.push(o.collaborator)}return t.unshift(null),t},t.prototype.refreshElementPosition=function(){this.minWidth=this.documentAnnotator.annotatorContainer.offsetWidth;for(var t=Object.keys(this.tokens),e=0;e<t.length;e++){(Q=this.tokens[t[e]]).hide()}var n=Object.keys(this.tags);for(e=0;e<n.length;e++){(Z=this.tags[n[e]]).hide()}var o=Object.keys(this.relations);for(e=0;e<o.length;e++){(tt=this.relations[o[e]]).hide()}var i=Object.keys(this.connectors);for(e=0;e<i.length;e++){this.connectors[i[e]].hide()}var a=Object.keys(this.collaboratorTexts);for(e=0;e<a.length;e++){(y=this.collaboratorTexts[a[e]]).setAttribute("x",-1e5),y.setAttribute("y",-1e5)}var s=Object.keys(this.collaboratorSeparators);for(e=0;e<s.length;e++){(p=this.collaboratorSeparators[s[e]]).setAttribute("x1",-1e5),p.setAttribute("x2",-1e5),p.setAttribute("y1",-1e5),p.setAttribute("y2",-1e5)}this.width=0,this.height=0;var r=2*this.documentAnnotator.annotator.config.style.margin.default,l=this.documentAnnotator.annotator.config.style.token.font.size+r,c=this.documentAnnotator.annotator.config.style.tag.font.size+r,h=this.documentAnnotator.annotator.config.style.relation.level.height+this.documentAnnotator.annotator.config.style.relation.text.font.size/2,g=this.getAllCollaborators(),u=this.startY;for(e=0;e<g.length;e++){var d=g[e],f=this.documentAnnotator.annotator.config.style.sentence.index.width+this.documentAnnotator.annotator.config.style.margin.default,m=0;if(!d||d&&this.expanded){if(d){if(!this.collaboratorTexts[d]){var p;(p=document.createElementNS(SVG_NS,"line")).annotatorElement=this,p.setAttribute("stroke","#000000"),p.setAttribute("stroke-width","1"),p.setAttribute("stroke-linecap","round"),p.setAttribute("stroke-dasharray","1, 6"),this.collaboratorSeparatorElement.appendChild(p),this.collaboratorSeparators[d]=p;var y=document.createElementNS(SVG_NS,"text"),v=d+" ["+this.documentAnnotator.getCollaborationByCollaboratorKey(d).status+"]";y.appendChild(document.createTextNode(v)),y.annotatorElement=this,this.collaboratorTextElement.appendChild(y),this.collaboratorTexts[d]=y}this.collaboratorSeparators[d].setAttribute("x1",this.documentAnnotator.annotator.config.style.sentence.index.width+5),this.collaboratorSeparators[d].setAttribute("x2",this.documentAnnotator.annotator.config.style.sentence.index.width+500),this.collaboratorSeparators[d].setAttribute("y1",u+10),this.collaboratorSeparators[d].setAttribute("y2",u+10),this.collaboratorTexts[d].setAttribute("x",this.documentAnnotator.annotator.config.style.sentence.index.width+5),this.collaboratorTexts[d].setAttribute("y",u+25),this.collaboratorTexts[d].style["font-size"]=this.documentAnnotator.annotator.config.style.sentence.index.font.size+"px",u+=30}for(var b=this.getRelationLevelMap(d),k=this.getElementKeys(this.relations,d),E=[],A=[],x=[],C=0,T=[],S=0;S<k.length;S++){if((tt=this.relations[k[S]]).isFromTopRelation)E.push(tt);else if(tt.isFromBottomRelation)A.push(tt);else{C=(R=b[tt.key])>C?R:C,x.push(tt),T[tt.fromTag.key]||(T[tt.fromTag.key]=[]),T[tt.fromTag.key].push(tt)}}var w=E.length?u+2*this.documentAnnotator.annotator.config.style.margin.default+this.documentAnnotator.annotator.config.style.padding.interrelation:u+2*this.documentAnnotator.annotator.config.style.margin.default,O=C*h;for(S=0;S<x.length;S++){var R,B=(R=b[(tt=x[S]).key])*h;tt.startY=w+(O-B),tt.height=B}k.length&&(m+=O+r),E.length&&(m+=this.documentAnnotator.annotator.config.style.padding.interrelation);var M=this.getElementKeys(this.tags,d),I=u;I+=k.length?O+this.documentAnnotator.annotator.config.style.margin.default:0,I+=E.length?this.documentAnnotator.annotator.config.style.padding.interrelation:0;for(S=0;S<M.length;S++){(Z=this.tags[M[S]]).startY=I+this.documentAnnotator.annotator.config.style.margin.default}M.length&&(m+=c);var D=this.getElementKeys(this.tokens,d).sort(function(t,e){var n=d?1:0;return t.split(":")[1+n]-e.split(":")[1+n]}),H=u;H+=M.length?c:0,H+=k.length?O+this.documentAnnotator.annotator.config.style.margin.default:0,H+=E.length?this.documentAnnotator.annotator.config.style.padding.interrelation:0;var j=[];for(S=0;S<M.length;S++)for(var N=(Z=this.tags[M[S]]).input.range.split(":"),U=parseInt(N[1]);U<=parseInt(N[2]);U++)j[U]=Z;var V=[];for(S=0;S<D.length;S++)if(-1==V.indexOf(S)){var K=D[S];if(Z=j[S]){N=Z.input.range.split(":");var F=0;for(U=parseInt(N[1]);U<=parseInt(N[2]);U++){var L=d?d+":"+Z.sentence.key+":"+U:Z.sentence.key+":"+U;(Q=this.tokens[L]).setY(H+l-this.documentAnnotator.annotator.config.style.margin.default),Q.setX(f),F+=Q.getLength(),f+=Q.getLength(),V.push(U)}if(F>Z.getTextLength()){Z.width=F;L=d?d+":"+Z.sentence.key+":"+N[1]:Z.sentence.key+":"+N[1];Z.startX=this.tokens[L].getX()}else{var z=Z.getTextLength()-F;for(U=parseInt(N[1]);U<=parseInt(N[2]);U++){L=d?d+":"+Z.sentence.key+":"+U:Z.sentence.key+":"+U;(Q=this.tokens[L]).setX(Q.getX()+z/2)}Z.width=Z.getTextLength();L=d?d+":"+Z.sentence.key+":"+N[1]:Z.sentence.key+":"+N[1];Z.startX=this.tokens[L].getX()-z/2,f+=z}}else{(Q=this.tokens[K]).setY(H+l-this.documentAnnotator.annotator.config.style.margin.default),Q.setX(f),f+=Q.getLength(),V.push(S)}}D.length&&(m+=l);for(S=0;S<E.length;S++){(tt=E[S]).startY=u+5;var G=tt.fromTag.sentence.key==this.key?tt.fromTag:tt.toTag;tt.height=Math.abs(G.startY-tt.startY)}for(S=0;S<A.length;S++){(tt=A[S]).startY=u+m-this.documentAnnotator.annotator.config.style.margin.default;G=tt.fromTag.sentence.key==this.key?tt.fromTag:tt.toTag;tt.height=Math.abs(G.startY-tt.startY)-3}A.length&&(m+=this.documentAnnotator.annotator.config.style.padding.interrelation);for(S=0;S<M.length;S++){var Y=T[(Z=this.tags[M[S]]).key];if(Y)for(U=0;U<Y.length;U++){d=(tt=Y[U]).collaborator;var X=tt.fromTag.startX<tt.toTag.startX?tt.fromTag:tt.toTag,_=tt.fromTag.startX<tt.toTag.startX?tt.toTag:tt.fromTag,P=_.startX-(X.startX+X.width),q=tt.textElement.getComputedTextLength()+20;if(P<q){f+=z=q-P;tt.collaborator&&tt.collaborator;for(var W=X.getEndToken().index+1,J=_.getStartToken().index-1,$=(D=this.getElementKeys(this.tokens,d),0);$<D.length;$++){var Q;(Q=this.tokens[D[$]]).index>=W&&(Q.index>J?Q.xShiftElementPosition(z):Q.xShiftElementPosition(z/2))}for(M=this.getElementKeys(this.tags,d),$=0;$<M.length;$++){(Z=this.tags[M[$]]).getStartToken().index>=W&&(Z.getStartToken().index>J?Z.xShiftElementPosition(z):Z.xShiftElementPosition(z/2))}}}}for(S=0;S<M.length;S++){var Z;(Z=this.tags[M[S]]).refreshElementPosition()}for(S=0;S<k.length;S++){var tt;(tt=this.relations[k[S]]).refreshElementPosition()}var et=this.getElementKeys(this.connectors,d);for(S=0;S<et.length;S++){this.connectors[et[S]].refreshElementPosition()}var nt=f+4*this.documentAnnotator.annotator.config.style.margin.default;this.width=nt>this.width?nt:this.width,this.height+=m,d&&(this.height+=30),u+=m}}this.updateBackground()},t.prototype.updateBackground=function(){this.sentenceBackground.setAttribute("height",this.height),this.sentenceBackground.setAttribute("width",this.width<this.minWidth?this.minWidth:this.width),this.sentenceBackground.setAttribute("y",this.startY),this.sentenceIndexBackground.setAttribute("height",this.height),this.sentenceIndexBackground.setAttribute("y",this.startY),this.sentenceIndexText.setAttribute("y",this.startY+this.height/2+this.documentAnnotator.annotator.config.style.sentence.index.font.size/2);for(var t=Object.keys(this.collaboratorSeparators),e=0;e<t.length;e++){this.collaboratorSeparators[t[e]].setAttribute("x2",this.width<this.minWidth?this.minWidth:this.width)}},t}()),Tag=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o,i){this.documentAnnotator=t,this.sentence=e,this.input=n,this.tokens=o,this.simpleKey=this.input.range,this.key=this.input.range,this.collaborator=i,this.collaborator&&(this.key=this.collaborator+":"+this.key),this.startX=0,this.startY=0,this.width=0,this.height=0,this.outcomeRelations=[],this.state="default",this.svgElement=document.createElementNS(SVG_NS,"g"),this.svgElement.setAttribute("key",this.key),this.svgElement.annotatorElement=this;var a=this,s=function(t,e){t.annotatorElement=a,a.svgElement.appendChild(t),e&&(t.mouseOverHandler=function(){this.annotatorElement.highlightOn(),this.annotatorElement.highlightChainOn()},t.mouseOutHandler=function(){this.annotatorElement.highlightOff(),this.annotatorElement.highlightChainOff()},t.setAttribute("onmouseover","this.mouseOverHandler();"),t.setAttribute("onmouseout","this.mouseOutHandler();"))};this.backgroundElement=document.createElementNS(SVG_NS,"rect"),this.backgroundElement.setAttribute("stroke","#ffffff"),this.backgroundElement.setAttribute("stroke-width","1"),this.backgroundElement.setAttribute("fill-opacity",this.documentAnnotator.annotator.config.style.opacity.default),this.backgroundElement.setAttribute("height",this.documentAnnotator.annotator.config.style.tag.font.size+2*this.documentAnnotator.annotator.config.style.margin.default),this.backgroundElement.setAttribute("class","annotatorjs-pointable"),s(this.backgroundElement,!0),this.tokenBackgroundElement=document.createElementNS(SVG_NS,"rect"),this.tokenBackgroundElement.setAttribute("stroke","#ffffff"),this.tokenBackgroundElement.setAttribute("fill-opacity",this.documentAnnotator.annotator.config.style.opacity.default),this.tokenBackgroundElement.setAttribute("stroke-width","1"),this.tokenBackgroundElement.setAttribute("height",this.documentAnnotator.annotator.config.style.token.font.size+this.documentAnnotator.annotator.config.style.margin.default),this.tokenBackgroundElement.setAttribute("class","annotatorjs-pointable"),s(this.tokenBackgroundElement),this.textElement=document.createElementNS(SVG_NS,"text"),this.textElement.setAttribute("class","annotatorjs-pointable annotatorjs-unselectable"),this.textElement.style["font-size"]=this.documentAnnotator.annotator.config.style.tag.font.size+"px",this.textElement.appendChild(document.createTextNode(this.input.label)),s(this.textElement,!0),this.refreshColor(),this.enableHighlightHandler(),this.highlightOff()}return t.prototype.updateKey=function(){this.key=this.input.range,this.collaborator&&(this.key=this.collaborator+":"+this.key)},t.prototype.refreshColor=function(){var t=this.documentAnnotator.annotator.config.style.color.primary.default,e=this.documentAnnotator.annotator.config.style.color.secondary.default,n=this.documentAnnotator.annotator.config.style.font.color.default;"active"==this.state?(t=this.documentAnnotator.annotator.config.style.color.primary.active,e=this.documentAnnotator.annotator.config.style.color.secondary.active,n=this.documentAnnotator.annotator.config.style.font.color.active):"inactive"==this.state&&(t=this.documentAnnotator.annotator.config.style.color.primary.inactive,e=this.documentAnnotator.annotator.config.style.color.secondary.inactive,n=this.documentAnnotator.annotator.config.style.font.color.inactive),this.backgroundElement.setAttribute("fill",t),this.tokenBackgroundElement.setAttribute("fill",e),this.textElement.setAttribute("fill",n)},t.prototype.active=function(){this.state="active",this.refreshColor()},t.prototype.inactive=function(){this.state="inactive",this.refreshColor()},t.prototype.enableHighlightHandler=function(){this.enabledHighlightHandler=!0},t.prototype.disableHighlightHandler=function(){this.enabledHighlightHandler=!1},t.prototype.highlightOn=function(){this.enabledHighlightHandler&&(this.textElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.font.color.highlight),this.backgroundElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.color.primary.highlight),this.tokenBackgroundElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.color.primary.light))},t.prototype.highlightOff=function(){this.enabledHighlightHandler&&this.refreshColor()},t.prototype.highlightChainOn=function(){if(this.enabledHighlightHandler)for(var t=0;t<this.outcomeRelations.length;t++)this.outcomeRelations[t].highlightOn(),this.outcomeRelations[t].toTag.highlightOn()},t.prototype.highlightChainOff=function(){if(this.enabledHighlightHandler)for(var t=0;t<this.outcomeRelations.length;t++)this.outcomeRelations[t].highlightOff(),this.outcomeRelations[t].toTag.highlightOff()},t.prototype.getTextLength=function(){return this.textElement.getComputedTextLength()},t.prototype.addOutcomeRelation=function(t){this.outcomeRelations.push(t)},t.prototype.removeOutcomeRelation=function(t){ArrayUtil.removeByValue(this.outcomeRelations,t)},t.prototype.shiftElementPosition=function(t){this.startY+=t,this.refreshElementPosition()},t.prototype.xShiftElementPosition=function(t){this.startX+=t,this.refreshElementPosition()},t.prototype.getStartToken=function(){if(!this.startToken)for(var t=0;t<this.tokens.length;t++){var e=this.tokens[t];(!this.startToken||this.startToken.index>e.index)&&(this.startToken=e)}return this.startToken},t.prototype.getEndToken=function(){if(!this.endToken)for(var t=0;t<this.tokens.length;t++){var e=this.tokens[t];(!this.endToken||this.endToken.index<e.index)&&(this.endToken=e)}return this.endToken},t.prototype.refreshElementPosition=function(){this.textElement.setAttribute("x",this.startX+this.width/2-this.getTextLength()/2),this.textElement.setAttribute("y",this.startY+this.documentAnnotator.annotator.config.style.margin.default+this.documentAnnotator.annotator.config.style.tag.font.size),this.backgroundElement.setAttribute("x",this.startX),this.backgroundElement.setAttribute("y",this.startY),this.backgroundElement.setAttribute("width",this.width),this.tokenBackgroundElement.setAttribute("x",this.startX),this.tokenBackgroundElement.setAttribute("y",this.startY+parseFloat(this.backgroundElement.getAttribute("height"))),this.tokenBackgroundElement.setAttribute("width",this.width)},t.prototype.hide=function(){this.textElement.setAttribute("x",-1e5),this.backgroundElement.setAttribute("x",-1e5),this.tokenBackgroundElement.setAttribute("x",-1e5),this.textElement.setAttribute("y",-1e5),this.backgroundElement.setAttribute("y",-1e5),this.tokenBackgroundElement.setAttribute("y",-1e5)},t}()),Token=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o,i){this.documentAnnotator=t,this.sentence=e,this.input=n,this.index=o,this.simpleKey=e.key+":"+o,this.key=e.key+":"+o,this.collaborator=i,this.collaborator&&(this.key=this.collaborator+":"+this.key),this.connector=null,this.svgElement=document.createElementNS(SVG_NS,"tspan"),this.documentAnnotator.annotator.isInValidationMode()?this.svgElement.setAttribute("class","annotatorjs-unselectable annotatorjs-token"):this.svgElement.setAttribute("class","annotatorjs-selectable annotatorjs-token"),this.svgElement.annotatorElement=this,this.svgElement.mouseOverHandler=function(){this.annotatorElement.connector&&(this.annotatorElement.highlightOn(),this.annotatorElement.highlightChainOn())},this.svgElement.mouseOutHandler=function(){this.annotatorElement.connector&&(this.annotatorElement.highlightOff(),this.annotatorElement.highlightChainOff())},this.svgElement.setAttribute("onmouseover","this.mouseOverHandler();"),this.svgElement.setAttribute("onmouseout","this.mouseOutHandler();");var a=n.FORM;-1==["?","!",".",","].indexOf(a)&&0!=o&&(a=" "+a),this.svgElement.appendChild(document.createTextNode(a)),this.enableHighlightHandler(),this.highlightOff()}return t.prototype.setConnector=function(t){this.connector=t,this.svgElement.setAttribute("class","annotatorjs-pointable annotatorjs-selectable annotatorjs-token")},t.prototype.removeConnector=function(){this.connector=null,this.documentAnnotator.annotator.isInValidationMode()?this.svgElement.setAttribute("class","annotatorjs-unselectable annotatorjs-token"):this.svgElement.setAttribute("class","annotatorjs-selectable annotatorjs-token")},t.prototype.enableHighlightHandler=function(){this.enabledHighlightHandler=!0},t.prototype.disableHighlightHandler=function(){this.enabledHighlightHandler=!1},t.prototype.highlightOn=function(){this.enabledHighlightHandler&&(this.svgElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.font.color.highlight),this.connector&&this.connector.highlightOn())},t.prototype.highlightOff=function(){this.enabledHighlightHandler&&(this.collaborator?this.svgElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.token.font.color.validation):this.svgElement.setAttribute("fill",this.documentAnnotator.annotator.config.style.font.color.default),this.connector&&this.connector.highlightOff())},t.prototype.highlightChainOn=function(){this.enabledHighlightHandler&&this.connector&&(this.connector.relation.highlightOn(),this.connector.relation.toTag.highlightOn(),this.connector.relation.fromTag.highlightOn())},t.prototype.highlightChainOff=function(){this.enabledHighlightHandler&&this.connector&&(this.connector.relation.highlightOff(),this.connector.relation.toTag.highlightOff(),this.connector.relation.fromTag.highlightOff())},t.prototype.getX=function(){return parseFloat(this.svgElement.getAttribute("x"))},t.prototype.setX=function(t){this.svgElement.setAttribute("x",t)},t.prototype.getY=function(){return parseFloat(this.svgElement.getAttribute("y"))},t.prototype.setY=function(t){this.svgElement.setAttribute("y",t)},t.prototype.getLength=function(){return parseFloat(this.svgElement.getComputedTextLength())},t.prototype.shiftElementPosition=function(t){this.setY(this.getY()+t)},t.prototype.xShiftElementPosition=function(t){this.setX(this.getX()+t)},t.prototype.hide=function(){this.svgElement.setAttribute("x",-1e5),this.svgElement.setAttribute("y",-1e5)},t}()),DocumentAnnotator=(SVG_NS="http://www.w3.org/2000/svg",function(){function t(t,e,n,o,i,a,s,r){this.annotator=t,this.container=e,this.contextMenu=n,this.entities=o||[],this.availableStatus=i,this.doc=this.annotator.isInViewMode()?clone(a):a,this.annotatorOnChange=s,this.maxDocumentHeight=r,this.collaborators=[],this.sentences=[],this.tokens=[],this.tags=[],this.relations=[],this.connectors=[],this.relationsByTagKey=[],this.annotatorContainer=document.createElement("div"),this.annotatorContainer.style.height=0,this.annotatorContainer.style.overflow="auto",this.container.appendChild(this.annotatorContainer),this.svgElement=document.createElementNS(SVG_NS,"svg"),this.svgElement.setAttribute("style","font-family: "+this.annotator.config.style.font.family+";"),this.svgElement.setAttribute("width",100),this.svgElement.setAttribute("class","annotatorjs-disabled"),this.svgElement.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),this.annotatorContainer.appendChild(this.svgElement)}return t.prototype.clean=function(){var t={action:"CLEAN",firedBy:"DEFAULT",dependencies:[],changedSentences:[]};this.doc.status=this.availableStatus&&this.availableStatus.length>0?this.availableStatus[0]:null;for(var e=0;e<this.doc.sentences.length;e++){var n=this.doc.sentences[e];this.cleanRange(this.doc,e,0,n.tokens.length-1,!1,t)}this.onChange(t,!1,!1)},t.prototype.buildEntitiesMap=function(){var t={},e=function(n,o){if(n.children){t[n.label]||(t[n.label]=[]);var i=o.concat(n);i.forEach(function(e){t[e.label].push(...n.children.map(t=>t.label))}),n.children.forEach(function(t){e(t,i)})}};this.entities.forEach(function(t){e(t,[])});var n={},o=function(e,i){var a={};e&&(a=clone(n[e.label])),i.relations&&i.relations.forEach(function(e){a[e.label]={targets:[]},e.targets.forEach(function(n){a[e.label].targets.push(n),t[n]&&a[e.label].targets.push(...t[n]),a[e.label].targets=ArrayUtil.getUnique(a[e.label].targets)}),e.max&&(a[e.label].max=e.max)}),n[i.label]=a,i.children&&i.children.forEach(function(t){o(i,t)})};this.entities.forEach(function(t){o(null,t)}),this.entitiesMap=n},t.prototype.init=function(){var t=this;window.addEventListener("resize",function(){t.refresh()});t=this;if(this.entities.sort(function(t,e){return t.label>e.label?1:e.label>t.label?-1:0}),this.buildEntitiesMap(),this.annotator.config.strictMode){if(this.fixDocument(this.doc),this.doc.collaborations)for(var e=0;e<this.doc.collaborations.length;e++){var n=this.doc.collaborations[e];this.fixDocument(n),this.collaborators.push(this.getCollaboratorKeyByCollaboration(n))}this.annotator.isInValidationMode()&&this.collaborationsBasedMainFix()}this.appendDefs(),this.initScrollListener(),this.initMouseEventHandler();this.documentHeader=new DocumentHeader(this,this.availableStatus,this.doc.id,function(e){e.atTime=Math.round((new Date).getTime()/1e3),t.doc.logs.push(e),t.annotatorOnChange(t,e)}),this.maxDocumentHeight=this.maxDocumentHeight-this.documentHeader.height;for(e=0;e<this.doc.sentences.length;e++){var o=new Sentence(this,e,this.annotator.isInValidationMode(),function(e){var n=[e];t.currentExpandedSentence&&t.currentExpandedSentence!=e&&(t.currentExpandedSentence.expanded=!1,n.push(t.currentExpandedSentence)),t.currentExpandedSentence=e,t.onChange({changedSentences:n},!1,!1),t.annotator.updateSize()});this.sentences[e]=o;for(var i=0;i<this.doc.sentences[e].tokens.length;i++){var a=new Token(this,o,this.doc.sentences[e].tokens[i],i);if(this.tokens[a.key]=a,o.addToken(a),this.doc.collaborations)for(var s=0;s<this.doc.collaborations.length;s++){n=this.doc.collaborations[s];var r=this.getCollaboratorKeyByCollaboration(n),l=new Token(this,o,this.doc.sentences[e].tokens[i],i,r);this.tokens[l.key]=l,o.addToken(l)}}}this.arc=new Arc(this),this.svgElement.appendChild(this.arc.svgElement);var c=function(e,n){for(var o=0;o<e.tags.length;o++){for(var i=e.tags[o].range.split(":"),a=t.sentences[parseInt(i[0])],s=[],r=parseInt(i[1]);r<=parseInt(i[2]);r++){var l=parseInt(i[0])+":"+r;n&&(l=n+":"+l),s.push(t.tokens[l])}var c=new Tag(t,a,e.tags[o],s,n);t.tags[c.key]=c,a.addTag(c)}};if(c(this.doc),this.doc.collaborations)for(e=0;e<this.doc.collaborations.length;e++){c(n=this.doc.collaborations[e],r=this.getCollaboratorKeyByCollaboration(n))}var h=function(e,n){for(var o=0;o<e.relations.length;o++){var i=e.relations[o].from.range.split(":"),a=e.relations[o].to.range.split(":"),s=t.getTag(e,i[0],i[1],i[2]),r=t.getTag(e,a[0],a[1],a[2]),l=t.sentences[parseInt(i[0])],c=new Relation(t,l,e.relations[o],s,r,null,n);if(t.relations[c.key]=c,t.relationsByTagKey[s.key]||(t.relationsByTagKey[s.key]=[]),t.relationsByTagKey[s.key].push(c),t.relationsByTagKey[r.key]||(t.relationsByTagKey[r.key]=[]),t.relationsByTagKey[r.key].push(c),l.addRelation(c),s.addOutcomeRelation(c),i[0]!=a[0]){var h=t.sentences[parseInt(a[0])],g=new Relation(t,h,e.relations[o],s,r,c,n);c.mirrorRelation=g,t.relationsByTagKey[s.key].push(g),t.relationsByTagKey[r.key].push(g),h.addRelation(g),s.addOutcomeRelation(g)}for(var u=0;u<c.input.connectors.length;u++){for(var d=c.input.connectors[u],f=t.sentences[parseInt(d.split(":")[0])],m=d.split(":"),p=[],y=parseInt(m[1]);y<=parseInt(m[2]);y++){var v=t.getToken(e,f.key,y);p.push(v)}var b=new Connector(t,f,d,p,c,n);f.addConnector(b),c.addConnector(b),t.connectors[b.key]=b;for(y=0;y<p.length;y++)p[y].setConnector(b)}}};if(h(this.doc),this.doc.collaborations)for(e=0;e<this.doc.collaborations.length;e++){h(n=this.doc.collaborations[e],r=this.getCollaboratorKeyByCollaboration(n))}setTimeout(function(){t.onChange({action:"OPEN",changedSentences:t.sentences},!1,!0)},200)},t.prototype.getCollaboratorKeyByCollaboration=function(t){return(t.collaborator.firstName||" ")+" "+(t.collaborator.lastName||" ")+", "+t.collaborator.email},t.prototype.getTagKeyByInput=function(t,e){var n=e.range;return t&&t.collaborator&&(n=this.getCollaboratorKeyByCollaboration(t)+":"+n),n},t.prototype.getRelationKeyByInput=function(t,e){var n=e.from.range+":"+e.from.label+":"+e.to.range+":"+e.to.label+":"+e.label;return t&&t.collaborator&&(n=this.getCollaboratorKeyByCollaboration(t)+":"+n),n},t.prototype.getConnectorKeyByInput=function(t,e,n){var o=e.from.range+":"+e.from.label+":"+e.to.range+":"+e.to.label+":"+e.label+":"+n;return t&&t.collaborator&&(o=this.getCollaboratorKeyByCollaboration(t)+":"+o),o},t.prototype.collaborationsBasedMainFix=function(){var t=this,e=[],n=[],o=[];if(this.doc.collaborations){for(var i=0;i<this.doc.collaborations.length;i++){var a=this.doc.collaborations[i];a.tags.forEach(function(n){e[t.getTagKeyByInput(null,n)]=!0}),a.relations.forEach(function(e){n[t.getRelationKeyByInput(null,e)]=!0;for(var i=0;i<e.connectors.length;i++)o[t.getConnectorKeyByInput(null,e,e.connectors[i])]=!0})}var s=Object.keys(e),r=[];this.doc.tags.forEach(function(e){var n=t.getTagKeyByInput(null,e);-1==s.indexOf(n)&&r.push(e)}),r.forEach(function(e){ArrayUtil.removeByValue(t.doc.tags,e)});var l=Object.keys(n),c=Object.keys(o),h=[];this.doc.relations.forEach(function(e){var n=t.getRelationKeyByInput(null,e);if(-1==l.indexOf(n))h.push(e);else{for(var o=[],i=0;i<e.connectors.length;i++){var a=t.getConnectorKeyByInput(null,e,e.connectors[i]);-1!=c.indexOf(a)&&o.push(e.connectors[i])}e.connectors=o}}),h.forEach(function(e){ArrayUtil.removeByValue(t.doc.relations,e)}),this.fixDocument(this.doc)}},t.prototype.fixDocument=function(t){var e=this;void 0==t.comments&&(t.comments="");var n=ArrayUtil.getSanitized(Object.keys(this.entitiesMap));!t.status&&this.availableStatus&&this.availableStatus.length>0&&(t.status=this.availableStatus[0]),t.tags||(t.tags=[]),t.relations||(t.relations=[]);for(var o=0;o<t.relations.length;o++)t.relations[o].connectors||(t.relations[o].connectors=[]);t.logs||(t.logs=[]);var i=this.getSentenceMap(t);t.tags=ArrayUtil.getUnique(t.tags,function(t){return t.range}),t.relations=ArrayUtil.getUnique(t.relations,function(t){return t.from.range+":"+t.to.range+":"+t.label});for(o=0;o<t.relations.length;o++)t.relations[o].connectors=ArrayUtil.getUnique(t.relations[o].connectors,function(t){return t});for(o=0;o<this.doc.sentences.length;o++){var a=this.doc.sentences[o];Object.keys(i[o].tags).forEach(function(s){var r=i[o].tags[s],l=r.range.split(":"),c=parseInt(l[1]),h=parseInt(l[2]);if(c<0||h>=a.tokens.length||-1==n.indexOf(r.label))ArrayUtil.removeByValue(t.tags,r);else{var g=e.getValidRange(t,r);null==g.startIndex?ArrayUtil.removeByValue(t.tags,r):g.startIndex==c&&g.endIndex==h||ArrayUtil.removeByValue(t.tags,r)}})}for(o=0;o<this.doc.sentences.length;o++){a=this.doc.sentences[o];Object.keys(i[o].outcomeRelations).forEach(function(n){var s=i[o].outcomeRelations[n],r=parseInt(s.from.range.split(":")[0]),l=parseInt(s.to.range.split(":")[0]),c=e.getTagKeyByInput(t,s.from),h=e.getTagKeyByInput(t,s.to),g=i[r].tags[c],u=i[l].tags[h];if(g&&u&&g.label==s.from.label&&u.label==s.to.label&&e.entitiesMap[s.from.label]&&e.entitiesMap[s.from.label][s.label]&&-1!=e.entitiesMap[s.from.label][s.label].targets.indexOf(s.to.label))for(var d=0;d<s.connectors.length;d++){var f=s.connectors[d],m=f.split(":"),p=parseInt(m[1]),y=parseInt(m[2]);if(p<0||y>=a.tokens.length)ArrayUtil.removeByValue(s.connectors,f);else{var v=e.getValidRange(t,{from:{label:s.from.label,range:s.from.range},to:{label:s.to.label,range:s.to.range},label:s.label,range:f});null==v.startIndex?ArrayUtil.removeByValue(s.connectors,f):v.startIndex==p&&v.endIndex==y||ArrayUtil.removeByValue(s.connectors,f)}}else ArrayUtil.removeByValue(t.relations,s)})}},t.prototype.appendDefs=function(){var t=document.createElementNS(SVG_NS,"defs");this.svgElement.appendChild(t);var e=function(e,n,o){var i=document.createElementNS(SVG_NS,"marker");i.setAttribute("id",e),i.setAttribute("markerWidth","10"),i.setAttribute("markerHeight","10"),i.setAttribute("refX","9"),i.setAttribute("refY","6"),i.setAttribute("orient","auto"),t.appendChild(i);var a=document.createElementNS(SVG_NS,"path");a.setAttribute("d","M2,2 L2,10 L10,6 L2,2"),a.setAttribute("style","fill: "+n+";"),i.appendChild(a)};e("arrowMarker",this.annotator.config.style.relation.arc.color.fill),e("arrowValidMarker",this.annotator.config.style.relation.arc.color.valid),e("arrowInvalidMarker",this.annotator.config.style.relation.arc.color.invalid),e("arrowHoverMarker",this.annotator.config.style.relation.arc.color.highlight);var n=function(e,n){var o=document.createElementNS(SVG_NS,"marker");o.setAttribute("id",e),o.setAttribute("markerWidth","8"),o.setAttribute("markerHeight","8"),o.setAttribute("refX","5"),o.setAttribute("refY","5"),t.appendChild(o);var i=document.createElementNS(SVG_NS,"circle");i.setAttribute("cx","5"),i.setAttribute("cy","5"),i.setAttribute("r","3"),i.setAttribute("style","fill: "+n+";"),o.appendChild(i)};n("circleMarker",this.annotator.config.style.relation.arc.color.fill),n("circleValidMarker",this.annotator.config.style.relation.arc.color.valid),n("circleInvalidMarker",this.annotator.config.style.relation.arc.color.invalid),n("circleHoverMarker",this.annotator.config.style.relation.arc.color.highlight)},t.prototype.initScrollListener=function(){var t=this;this.annotatorContainer.addEventListener("scroll",function(e){null==e&&(e=window.event);for(var n=0;n<t.sentences.length;n++){t.sentences[n].setSentenceIndexX(e.target.scrollLeft)}})},t.prototype.startRelationshipMode=function(t,e,n,o,i){if(!this.isInRelationshipMode){var a=this.sentences[e],s=e+":"+n;s=t.collaborator?this.getCollaboratorKeyByCollaboration(t)+":"+s:s;var r=a.getToken(s),l=e+":"+o;l=t.collaborator?this.getCollaboratorKeyByCollaboration(t)+":"+l:l;var c=a.getToken(l),h=e+":"+n+":"+o;t.collaborator&&(h=this.getCollaboratorKeyByCollaboration(t)+":"+h);var g=a.getTag(h),u=0,d=0,f=this.svgElement.getBoundingClientRect(),m=this.annotatorContainer.getBoundingClientRect(),p=this.annotatorContainer.scrollLeft,y=this.annotatorContainer.scrollTop;if(g)u=g.startX+g.width/2,d=g.startY,this.currentFromTag=g,this.currentFromTag.highlightChainOff(),this.currentFromTag.highlightOn(),this.currentFromTag.disableHighlightHandler();else{var v=Math.abs(r.getX()-c.getX())+c.getLength();u=r.getX()+v/2,d=r.getY()-5}var b=this;this.oldOnmousemove=this.svgElement.onmousemove,this.oldOnclick=this.svgElement.onclick,this.oldOncontextmenu=this.svgElement.oncontextmenu,this.isInRelationshipMode=!0,this.svgElement.style.cursor="pointer";this.svgElement.onmousemove=function(t){var n=null!=(t=t||window.event).target?t.target:t.srcElement,o=t.clientX-f.left+b.annotatorContainer.scrollLeft-p-2,i=t.clientY-f.top+b.annotatorContainer.scrollTop-y-2;b.arc.setPosition({x:u,y:d},{x:o,y:i}),Math.abs(t.clientY-(m.top+b.documentHeader.height))<30?b.annotatorContainer.scrollTop=b.annotatorContainer.scrollTop-30:Math.abs(t.clientY-m.bottom)<30&&(b.annotatorContainer.scrollTop=b.annotatorContainer.scrollTop+30),Math.abs(t.clientX-m.left)<30?b.annotatorContainer.scrollLeft=b.annotatorContainer.scrollLeft-30:Math.abs(t.clientX-m.right)<30&&(b.annotatorContainer.scrollLeft=b.annotatorContainer.scrollLeft+30),g?b.isValidToTarget(n)?b.arc.toValidState():b.isValidRelationShipTarget(n)?b.arc.toInvalidState():b.arc.toDefaultState():b.isValidConnectionTarget(n,e)?b.arc.toValidState():b.isValidConnectorTarget(n)?b.arc.toInvalidState():b.arc.toDefaultState()},this.svgElement.onclick=function(a){b.svgElement.onmousemove=null;var s=null!=(a=a||window.event).target?a.target:a.srcElement;if(g&&s.annotatorElement&&b.isValidRelationShipTarget(s))if(b.isValidToTarget(s)){var r=s.annotatorElement;b.currentToTag=r,b.currentToTag.highlightChainOff(),b.currentToTag.highlightOn(),b.currentToTag.disableHighlightHandler();var l=b.getAvailableRelations(b.currentFromTag,s.annotatorElement);if(1==l.length){var c=b.addRelation(t,b.currentFromTag,r,l[0],i);b.onChange(c,!0,!0),b.finishRelationshipMode()}else if(0==l.length)b.finishRelationshipMode();else{var h=[];l.forEach(function(e){h.push({label:e,group:"relation",action:function(){b.onChange(b.addRelation(t,b.currentFromTag,r,e,i),!0,!0),b.finishRelationshipMode()}})}),b.contextMenu.setItems(h),b.contextMenu.show(a,function(){},function(){b.contextMenu.setItems(h),b.contextMenu.show(a)})}}else b.finishRelationshipMode();else if(!g&&b.isValidConnectionTarget(a.target,e)){for(var u=b.getTokenDetailsMap(t,e),d=!0,f=n;f<=o;f++)if(u[f]&&!u[f].from){d=!1;break}d&&b.onChange(b.addConnector(t,a.target.annotatorElement,e,n,o,!0,i),!0,!0),b.finishRelationshipMode()}else b.finishRelationshipMode()},this.svgElement.oncontextmenu=function(){return!1}}},t.prototype.finishRelationshipMode=function(){this.isInRelationshipMode&&(this.currentFromTag&&(this.currentFromTag.enableHighlightHandler(),this.currentFromTag.highlightOff(),this.currentFromTag=null),this.currentToTag&&(this.currentToTag.enableHighlightHandler(),this.currentToTag.highlightOff(),this.currentToTag=null),this.isInRelationshipMode=!1,this.svgElement.style.cursor="auto",this.svgElement.onmousemove=this.oldOnmousemove,this.svgElement.onclick=this.oldOnclick,this.svgElement.oncontextmenu=this.oldOncontextmenu,this.contextMenu.close(),this.annotator.removeSelection(),this.arc.hide())},t.prototype.isValidRelationShipTarget=function(t){return t&&t.annotatorElement&&t.annotatorElement.constructor==Tag},t.prototype.isValidConnectorTarget=function(t){return t&&t.annotatorElement&&t.annotatorElement.constructor==Relation},t.prototype.getAvailableRelations=function(t,e){for(var n=[],o=[],i=0;i<t.outcomeRelations.length;i++){var a=t.outcomeRelations[i];n[a.input.label]?n[a.input.label]=n[a.input.label]+1:n[a.input.label]=1,a.toTag==e&&(o[a.input.label]=!0)}var s=[],r=Object.keys(this.entitiesMap[t.input.label]);for(i=0;i<r.length;i++){var l=r[i],c=this.entitiesMap[t.input.label][l].max;o[l]||-1==this.entitiesMap[t.input.label][l].targets.indexOf(e.input.label)||c&&n[l]&&!(c>n[l])||s.push(l)}return s},t.prototype.isValidToTarget=function(t){return this.currentFromTag&&this.isValidRelationShipTarget(t)&&t.annotatorElement&&t.annotatorElement.input&&t.annotatorElement.key!=this.currentFromTag.key&&this.getAvailableRelations(this.currentFromTag,t.annotatorElement).length>0},t.prototype.isValidConnectionTarget=function(t,e){return this.isValidConnectorTarget(t)},t.prototype.initMouseEventHandler=function(){var t=this;this.targetAnnotatorElement=null,this.targetOriginalOnmouseover=null,this.targetOriginalOnmouseout=null,this.svgElement.oncontextmenu=function(e){var n=null!=(e=e||window.e).target?e.target:e.srcElement;if(t.targetAnnotatorElement&&(t.targetAnnotatorElement.enableHighlightHandler(),t.targetAnnotatorElement.highlightChainOff(),t.targetAnnotatorElement.highlightOff()),t.annotator.isInAnnotationMode()&&!t.annotator.isReadOnly()){if(n.annotatorElement&&n.annotatorElement.sentence){t.targetAnnotatorElement=n.annotatorElement;t.onContextMenu(t.targetAnnotatorElement,e,function(){t.targetAnnotatorElement&&(t.targetAnnotatorElement.highlightOn(),t.targetAnnotatorElement.highlightChainOff(),t.targetAnnotatorElement.disableHighlightHandler())},function(){t.targetAnnotatorElement&&(t.targetAnnotatorElement.enableHighlightHandler(),t.targetAnnotatorElement.highlightOff())})}}else t.annotator.removeSelection();return!1};this.svgElement.getBoundingClientRect(),this.annotatorContainer.getBoundingClientRect(),this.annotatorContainer.scrollLeft,this.annotatorContainer.scrollTop;this.svgElement.onclick=function(e){var n={firedBy:"DEFAULT",dependencies:[],changedSentences:[]},o=null!=(e=e||window.e).target?e.target:e.srcElement;if(t.annotator.isInAnnotationMode()&&!t.annotator.isReadOnly()&&o.annotatorElement&&t.isValidRelationShipTarget(o)){var i=o.annotatorElement.input.range.split(":");t.startRelationshipMode(t.doc,i[0],i[1],i[2],n)}else if(t.annotator.isInValidationMode()&&!t.annotator.isReadOnly()){var a=!!o.annotatorElement.collaborator;o.annotatorElement.highlightChainOff&&o.annotatorElement.highlightChainOff();var s=function(e){var o=e.input.range.split(":");t.addTag(t.doc,parseInt(o[0]),parseInt(o[1]),parseInt(o[2]),e.input.label,!1,n)},r=function(e){var o=t.tags[e.fromTag.simpleKey];o&&o.input.label==e.fromTag.input.label||(s(e.fromTag),o=t.tags[e.fromTag.simpleKey]);var i=t.tags[e.toTag.simpleKey];i&&i.input.label==e.toTag.input.label||(s(e.toTag),i=t.tags[e.toTag.simpleKey]),t.addRelation(t.doc,o,i,e.input.label,n)},l=function(e){var o=e.input.split(":"),i=t.relations[e.relation.simpleKey];i||(r(e.relation),i=t.relations[e.relation.simpleKey]),t.addConnector(t.doc,i,parseInt(o[0]),parseInt(o[1]),parseInt(o[2]),!1,n)};switch(o.annotatorElement.constructor){case Tag:if(a){var c=t.tags[o.annotatorElement.simpleKey];if(c){var h=t.removeTag(t.doc,c,{});n.dependencies.push(h),n.changedSentences=n.changedSentences.concat(h.changedSentences),o.annotatorElement.input.label!=c.input.label?(n.action="MATCH",s(o.annotatorElement)):n.action="UNMATCH",t.onChange(n,!0,!0)}else n.action="MATCH",s(o.annotatorElement),t.onChange(n,!0,!0)}else n.action="UNMATCH",t.onChange(t.removeTag(t.doc,o.annotatorElement,n),!0,!0);break;case Relation:if(a){var g=t.relations[o.annotatorElement.simpleKey];g?(n.action="UNMATCH",t.onChange(t.removeRelation(t.doc,g,n),!0,!0)):(n.action="MATCH",r(o.annotatorElement),t.onChange(n,!0,!0))}else n.action="UNMATCH",t.onChange(t.removeRelation(t.doc,o.annotatorElement,n),!0,!0);break;case Connector:if(a){var u=t.connectors[o.annotatorElement.simpleKey];u?(n.action="UNMATCH",t.onChange(t.removeConnector(t.doc,u,n),!0,!0)):(n.action="MATCH",l(o.annotatorElement),t.onChange(n,!0,!0))}else n.action="UNMATCH",t.onChange(t.removeConnector(t.doc,o.annotatorElement,n),!0,!0);break;case Token:if(o.annotatorElement.connector)if(a){var d=t.tokens[o.annotatorElement.simpleKey];d&&d.connector?(n.action="UNMATCH",t.onChange(t.removeConnector(t.doc,d.connector,n),!0,!0)):(n.action="MATCH",l(o.annotatorElement.connector),t.onChange(n,!0,!0))}else n.action="UNMATCH",t.onChange(t.removeConnector(t.doc,o.annotatorElement.connector,n),!0,!0)}}}},t.prototype.getSentenceMap=function(t){for(var e=[],n=0;n<this.doc.sentences.length;n++)e[n]={tags:[],outcomeRelations:[],incomeRelations:[],connectors:[],outcomeConnectors:[],incomeConnectors:[]};for(n=t.tags.length-1;n>=0;n--){var o=t.tags[n],i=o.range.split(":"),a=this.getTagKeyByInput(t,o);e[parseInt(i[0])].tags[a]=o}for(n=t.relations.length-1;n>=0;n--){var s=t.relations[n],r=s.from.range.split(":"),l=s.to.range.split(":");a=this.getRelationKeyByInput(t,s);e[parseInt(r[0])].outcomeRelations[a]=s,e[parseInt(l[0])].incomeRelations[a]=s;for(var c=s.connectors.length-1;c>=0;c--){var h=s.connectors[c],g=(i=h.split(":"),this.getConnectorKeyByInput(t,s,h));e[parseInt(i[0])].connectors[g]=h,e[parseInt(r[0])].outcomeConnectors[a]=h,e[parseInt(l[0])].incomeConnectors[a]=h}}return e},t.prototype.getTokenDetailsMap=function(t,e){this.doc.sentences[e];for(var n=[],o=0;o<t.tags.length;o++){var i=t.tags[o],a=i.range.split(":");if(parseInt(a[0])==e)for(var s=parseInt(a[1]),r=parseInt(a[2]),l=s;l<=r;l++)void 0==n[l]&&(n[l]=i)}for(o=t.relations.length-1;o>=0;o--){var c=t.relations[o];for(l=0;l<c.connectors.length;l++){var h=c.connectors[l];a=h.split(":");if(parseInt(a[0])==e){s=parseInt(a[1]),r=parseInt(a[2]);for(var g=s;g<=r;g++)void 0==n[g]&&(n[g]={from:{label:c.from.label,range:c.from.range},to:{label:c.to.label,range:c.to.range},label:c.label,range:h})}}}return n},t.prototype.getValidRange=function(t,e){e.from;for(var n=e.range.split(":"),o=parseInt(n[0]),i=this.getTokenDetailsMap(t,o),a=parseInt(n[1]),s=parseInt(n[2]),r=null,l=s,c=a;c<=s;c++)if(deepEqual(i[c],e))null==r&&(r=c);else if(null!=r){l=c-1;break}return{startIndex:r,endIndex:null!=r?l:null}},t.prototype.cleanRange=function(t,e,n,o,i,a){var s=a;a.action?s={action:"REMOVE",subject:{type:"RANGE",value:{range:e+":"+n+":"+o}},dependencies:[],changedSentences:[]}:(a.action="REMOVE",a.subject={type:"RANGE",value:{range:e+":"+n+":"+o}},a.dependencies=[],a.changedSentences=[]);var r=this,l=this.getTokenDetailsMap(t,e),c=function(n,o){var a=l[n];if(a){var c=a.range.split(":");if(c[1]!=c[2]&&i){var h=o?e+":"+c[1]+":"+(n-1):e+":"+(n+1)+":"+c[2];parseInt(h.split(":")[1]),parseInt(h.split(":")[2]),a.from?r.removeConnector(t,r.connectors[r.getConnectorKeyByInput(t,a,a.range)],s):r.removeTag(t,r.tags[r.getTagKeyByInput(t,a)],s)}else a.from?r.removeConnector(t,r.connectors[r.getConnectorKeyByInput(t,a,a.range)],s):r.removeTag(t,r.tags[r.getTagKeyByInput(t,a)],s);l=r.getTokenDetailsMap(t,e)}};c(n,!0),c(o,!1);for(var h=n;h<=o;h++){var g=l[h];g&&(g.from?r.removeConnector(t,r.connectors[r.getConnectorKeyByInput(t,g,g.range)],s):r.removeTag(t,r.tags[r.getTagKeyByInput(t,g)],s),l=this.getTokenDetailsMap(t,e))}return s.changedSentences=ArrayUtil.getUnique(s.changedSentences.concat([])),s!=a&&s.changedSentences.length>0&&(a.dependencies.push(s),a.changedSentences=ArrayUtil.getUnique(a.changedSentences.concat(s.changedSentences))),a},t.prototype.getToken=function(t,e,n){var o=e+":"+n;return t.collaborator&&(o=this.getCollaboratorKeyByCollaboration(t)+":"+o),this.tokens[o]},t.prototype.addTag=function(t,e,n,o,i,a,s){var r={range:e+":"+Math.min(n,o)+":"+Math.max(n,o),label:i},l=s;s.action?(l={action:"ADD",dependencies:[],changedSentences:[]},s.dependencies.push(l)):(s.action="ADD",s.dependencies=[],s.changedSentences=[]),l.subject={type:"TAG",value:r};var c=this.sentences[e],h=[c];this.cleanRange(t,e,n,o,a,l);for(var g=[],u=n;u<=o;u++){var d=e+":"+u;t.collaborator&&(d=collaborator+":"+d),g.push(this.tokens[d])}var f=new Tag(this,c,r,g,t.collaborator?this.getCollaboratorKeyByCollaboration(t):null);return this.tags[f.key]=f,c.addTag(f),t.tags.unshift(r),this.annotator.lastTag=f,this.annotator.lastFromTag=f,l.changedSentences=ArrayUtil.getUnique(l.changedSentences.concat(h)),l!=s&&(s.changedSentences=ArrayUtil.getUnique(s.changedSentences.concat(l.changedSentences))),s},t.prototype.getTag=function(t,e,n,o){var i=e+":"+n+":"+o;return t.collaborator&&(i=this.getCollaboratorKeyByCollaboration(t)+":"+i),this.tags[i]},t.prototype.updateTag=function(t,e,n,o){var i=o;o.action?(i={action:"UPDATE",dependencies:[],changedSentences:[]},o.dependencies.push(i)):(o.action="UPDATE",o.dependencies=[],o.changedSentences=[]),i.subject={type:"TAG",value:{source:{label:e.input.label,range:e.input.range},target:{label:e.input.label,range:n}}};var a=this,s=e.sentence,r=parseInt(e.input.range.split(":")[0]),l=[s];delete this.tags[e.key],s.getTag(e.key)&&s.removeTag(e);var c=e.key,h=e.input.range;e.input.range=n,e.updateKey(),this.tags[e.key]=e,s.addTag(e);var g=this.getSentenceMap(t);return Object.keys(g[r].outcomeRelations).forEach(function(n){if(n){var o=g[r].outcomeRelations[n];if(o.from.range==h){var s=a.getRelationKeyByInput(t,o),l=a.relations[s];ArrayUtil.removeByValue(a.relationsByTagKey[c],o),a.updateRelation(t,l,e,l.toTag,o.label,i)}}}),Object.keys(g[r].incomeRelations).forEach(function(n){if(n){var o=g[r].incomeRelations[n];if(o.to.range==h){var s=a.getRelationKeyByInput(t,o),l=a.relations[s];ArrayUtil.removeByValue(a.relationsByTagKey[c],o),a.updateRelation(t,l,l.fromTag,e,o.label,i)}}}),i.changedSentences=ArrayUtil.getUnique(i.changedSentences.concat(l)),i!=o&&(o.changedSentences=ArrayUtil.getUnique(o.changedSentences.concat(i.changedSentences))),o},t.prototype.removeTag=function(t,e,n){var o=n;n.action?(o={action:"REMOVE",subject:{type:"TAG",value:e.input},dependencies:[],changedSentences:[]},n.dependencies.push(o)):(n.action="REMOVE",n.subject={type:"TAG",value:e.input},n.dependencies=[],n.changedSentences=[]);var i=[e.sentence],a=this.relationsByTagKey[e.key];if(a){for(var s=[],r=0;r<a.length;r++)s.push(a[r]);s=ArrayUtil.getUnique(s,function(t){return t.simpleKey});for(r=0;r<s.length;r++){var l=s[r];this.removeRelation(t,l,o)}}var c=e.sentence;return c.getTag(e.key)&&c.removeTag(e),delete this.tags[e.key],ArrayUtil.removeByValue(t.tags,e.input),o.changedSentences=ArrayUtil.getUnique(o.changedSentences.concat(i)),o!=n&&(n.changedSentences=ArrayUtil.getUnique(n.changedSentences.concat(o.changedSentences))),n},t.prototype.addRelation=function(t,e,n,o,i){if(-1==this.getAvailableRelations(e,n).indexOf(o))return i;var a=i,s={from:{label:e.input.label,range:e.input.range},to:{label:n.input.label,range:n.input.range},label:o,connectors:[]};i.action?(a={action:"ADD",subject:{type:"RELATION",value:s},dependencies:[],changedSentences:[]},i.dependencies.push(a)):(i.action="ADD",i.subject={type:"RELATION",value:s},i.dependencies=[],i.changedSentences=[]);var r=[e.sentence,n.sentence],l=new Relation(this,e.sentence,s,e,n,null,t.collaborator?this.getCollaboratorKeyByCollaboration(t):null);if(this.relations[l.key]=l,this.relationsByTagKey[e.key]||(this.relationsByTagKey[e.key]=[]),this.relationsByTagKey[e.key].push(l),this.relationsByTagKey[n.key]||(this.relationsByTagKey[n.key]=[]),this.relationsByTagKey[n.key].push(l),e.sentence.addRelation(l),e.addOutcomeRelation(l),e.sentence!=n.sentence){var c=new Relation(this,n.sentence,s,e,n,l,t.collaborator?this.getCollaboratorKeyByCollaboration(t):null);l.mirrorRelation=c,this.relationsByTagKey[e.key].push(c),this.relationsByTagKey[n.key].push(c),n.sentence.addRelation(c),e.addOutcomeRelation(c)}return t.relations.unshift(s),this.annotator.lastFromTag=e,a.changedSentences=ArrayUtil.getUnique(a.changedSentences.concat(r)),a!=i&&(i.changedSentences=ArrayUtil.getUnique(i.changedSentences.concat(a.changedSentences))),i},t.prototype.getRelation=function(t,e,n,o){var i=e.input.range+":"+e.input.label+":"+n.input.range+":"+n.input.label+":"+o;return t.collaborator&&(i=this.getCollaboratorKeyByCollaboration(t)+":"+i),this.relations[i]},t.prototype.updateRelation=function(t,e,n,o,i,a){var s=[e.sentence];e.input.from.range,e.input.to.range,e.input.label;return e.input.label=i,e.input.from.label=n.input.label,e.input.from.range=n.input.range,e.input.to.label=o.input.label,e.input.to.range=o.input.range,this.relationsByTagKey[e.fromTag.key]&&ArrayUtil.removeByValue(this.relationsByTagKey[e.fromTag.key],e),this.relationsByTagKey[e.toTag.key]&&ArrayUtil.removeByValue(this.relationsByTagKey[e.toTag.key],e),delete this.relations[e.key],e.sentence.getRelation(e.key)&&e.sentence.removeRelation(e),e.fromTag=n,e.toTag=o,e.refreshKey(),e.refreshTags(),e.refreshText(),this.relationsByTagKey[e.fromTag.key]||(this.relationsByTagKey[e.fromTag.key]=[]),this.relationsByTagKey[e.toTag.key]||(this.relationsByTagKey[e.toTag.key]=[]),this.relationsByTagKey[e.fromTag.key].push(e),this.relationsByTagKey[e.toTag.key].push(e),this.relations[e.key]=e,e.sentence.addRelation(e),e.mirrorRelation&&(e.mirrorRelation.sentence.getRelation(e.mirrorRelation.key)&&e.mirrorRelation.sentence.removeRelation(e.mirrorRelation),e.mirrorRelation.refreshKey(),e.mirrorRelation.refreshTags(),e.mirrorRelation.refreshText(),e.mirrorRelation.sentence.addRelation(e.mirrorRelation),s.push(e.mirrorRelation.sentence)),a.changedSentences=ArrayUtil.getUnique(a.changedSentences.concat(s)),a},t.prototype.removeRelation=function(t,e,n){var o=n;n.action?(o={action:"REMOVE",subject:{type:"RELATION",value:e.input},dependencies:[],changedSentences:[]},n.dependencies.push(o)):(n.action="REMOVE",n.subject={type:"RELATION",value:e.input},n.dependencies=[],n.changedSentences=[]);var i=[e.sentence];e.mirrorRelation&&i.push(e.mirrorRelation.sentence);var a=e.sentence;a.getRelation(e.key)&&a.removeRelation(e);for(var s=[],r=0;r<e.connectors.length;r++)s.push(e.connectors[r]);if(e.mirrorRelation){var l=e.mirrorRelation.sentence;l.getRelation(e.mirrorRelation.key)&&(l.removeRelation(e.mirrorRelation),e.fromTag.removeOutcomeRelation(e.mirrorRelation),ArrayUtil.removeByValue(this.relationsByTagKey[e.fromTag.key],e.mirrorRelation),ArrayUtil.removeByValue(this.relationsByTagKey[e.toTag.key],e.mirrorRelation));for(r=0;r<e.mirrorRelation.connectors.length;r++)s.push(e.mirrorRelation.connectors[r])}for(r=0;r<s.length;r++){var c=s[r];this.removeConnector(t,c,o)}return e.fromTag.removeOutcomeRelation(e),delete this.relations[e.key],ArrayUtil.removeByValue(this.doc.relations,e.input),ArrayUtil.removeByValue(this.relationsByTagKey[e.fromTag.key],e),ArrayUtil.removeByValue(this.relationsByTagKey[e.toTag.key],e),o.changedSentences=ArrayUtil.getUnique(o.changedSentences.concat(i)),o!=n&&(n.changedSentences=ArrayUtil.getUnique(n.changedSentences.concat(o.changedSentences))),n},t.prototype.getConnector=function(t,e,n,o,i){var a=e.key+":"+n+":"+o+":"+i;return t.collaborator&&(a=this.getCollaboratorKeyByCollaboration(t)+":"+a),this.connectors[a]},t.prototype.addConnector=function(t,e,n,o,i,a,s){var r=this.sentences[n],l=n+":"+o+":"+i,c={from:{label:e.fromTag.input.label,range:e.fromTag.input.range},to:{label:e.toTag.input.label,range:e.toTag.input.range},range:l,label:e.input.label},h=s;s.action?(h={action:"ADD",subject:{type:"CONNECTOR",value:c},dependencies:[],changedSentences:[]},s.dependencies.push(h)):(s.action="ADD",s.subject={type:"CONNECTOR",value:c},s.dependencies=[],s.changedSentences=[]),this.cleanRange(t,n,o,i,a,h),h.changedSentences=ArrayUtil.getUnique(h.changedSentences.concat([r])),h!=s&&(s.changedSentences=ArrayUtil.getUnique(s.changedSentences.concat(h.changedSentences)));for(var g=[],u=o;u<=i;u++){var d=t.collaborator?this.getCollaboratorKeyByCollaboration(t)+":"+n+":"+u:n+":"+u,f=r.getToken(d);g.push(f)}var m=new Connector(this,r,l,g,e,t.collaborator?this.getCollaboratorKeyByCollaboration(t):null);e.addConnector(m),r.addConnector(m),this.connectors[m.key]=m;for(u=0;u<g.length;u++)g[u].setConnector(m);return e.input.connectors.unshift(l),e.input.connectors=ArrayUtil.getUnique(e.input.connectors),s},t.prototype.updateConnector=function(t,e,n,o){var i={from:{label:e.relation.fromTag.input.label,range:e.relation.fromTag.input.range},to:{label:e.relation.toTag.input.label,range:e.relation.toTag.input.range},range:e.input,label:e.relation.input.label},a={from:{label:e.relation.fromTag.input.label,range:e.relation.fromTag.input.range},to:{label:e.relation.toTag.input.label,range:e.relation.toTag.input.range},range:n,label:e.relation.input.label},s=o;o.action?(s={action:"UPDATE",subject:{type:"CONNECTOR",value:{source:i,target:a}},dependencies:[],changedSentences:[]},o.dependencies.push(s)):(o.action="UPDATE",o.subject={type:"CONNECTOR",value:{source:i,target:a}},o.dependencies=[],o.changedSentences=[]);var r=e.input.split(":").map(function(t){return parseInt(t)}),l=(n=n.split(":").map(function(t){return parseInt(t)}),this.sentences[r[0]]),c=this.sentences[n[0]];ArrayUtil.removeByValue(e.relation.input.connectors,r),e.relation.input.connectors.push(n);for(var h=r[1];h<=r[2];h++){var g=t.collaborator?this.getCollaboratorKeyByCollaboration(t)+":"+l+":"+h:l+":"+h;l.getToken(g).removeConnector()}e.tokens=[],delete this.connectors[e.key],l.getConnector(e.key)&&l.removeConnector(e),e.input=n,e.refreshKey(),c.addConnector(e),this.connectors[e.key]=e;for(h=n[1];h<=n[2];h++){g=t.collaborator?this.getCollaboratorKeyByCollaboration(t)+":"+l+":"+h:l+":"+h;var u=c.getToken(g);e.tokens.push(u),u.setConnector(e)}return s.changedSentences=ArrayUtil.getUnique(s.changedSentences.concat([l,c])),s!=o&&(o.changedSentences=ArrayUtil.getUnique(o.changedSentences.concat(s.changedSentences))),o},t.prototype.removeConnector=function(t,e,n){var o={from:{label:e.relation.fromTag.input.label,range:e.relation.fromTag.input.range},to:{label:e.relation.toTag.input.label,range:e.relation.toTag.input.range},range:e.input,label:e.relation.input.label},i=n;n.action?(i={action:"REMOVE",subject:{type:"CONNECTOR",value:o},dependencies:[],changedSentences:[]},n.dependencies.push(i)):(n.action="REMOVE",n.subject={type:"CONNECTOR",value:o},n.dependencies=[],n.changedSentences=[]);var a=e.sentence;a.removeConnector(e),e.relation.removeConnector(e),e.relation.mirrorRelation&&e.relation.mirrorRelation.removeConnector(e),delete this.connectors[e.key],ArrayUtil.removeByValue(e.relation.input.connectors,e.input);for(var s=0;s<e.tokens.length;s++)e.tokens[s].removeConnector();return i.changedSentences=ArrayUtil.getUnique(i.changedSentences.concat([a])),i!=n&&(n.changedSentences=ArrayUtil.getUnique(n.changedSentences.concat(i.changedSentences))),n},t.prototype.onContextMenu=function(t,e,n,o){if(t&&t.sentence){var i=[],a=parseInt(t.sentence.key),s=this,r=function(t){s.onChange(t,!0,!0),s.annotator.removeSelection()},l={firedBy:"DEFAULT"};switch(t.constructor){case Tag:i=[{label:"Remove",group:"common",action:function(){r(s.removeTag(s.doc,t,l))}}];break;case Relation:i=[{label:"Remove",group:"common",action:function(){r(s.removeRelation(s.doc,t,l))}}];break;case Connector:i=[{label:"Remove",group:"common",action:function(){r(s.removeConnector(s.doc,t,l))}}];break;case Token:var c=s.annotator.getSelection();if(c&&c.anchor&&c.focus){if(c.anchor.sentence.key==c.focus.sentence.key){var h=Math.min(c.anchor.index,c.focus.index),g=Math.max(c.anchor.index,c.focus.index),u=function(t){t.group="entity",t.disabled||(t.action=function(){r(s.addTag(s.doc,a,h,g,t.label,!0,l))}),t.children&&t.children.forEach(function(t){u(t)})};(i=clone(s.entities)).forEach(function(t){u(t)}),i.unshift(null),i.unshift({label:"Connect",action:function(){s.startRelationshipMode(s.doc,a,h,g,l)}}),i.unshift({label:"Remove",action:function(){r(s.cleanRange(s.doc,a,h,g,!0,l))}})}}else!c&&t.connector?i=[{label:"Remove",action:function(){r(s.removeConnector(s.doc,t.connector,l))}}]:s.annotator.removeSelection()}this.contextMenu.setItems(i),this.contextMenu.show(e,n,o)}},t.prototype.refresh=function(t){this.container.style.width=this.annotator.container.offsetWidth+"px",t=t||this.sentences;for(var e=0,n=0,o=0,i=0;i<this.sentences.length;i++){var a=this.sentences[i];if(-1!=t.indexOf(a)){a.setStartY(e);var s=a.height;a.refreshElementPosition(),o+=a.height-s}else a.shiftElementPosition(o);var r=a.width<a.minWidth?a.minWidth:a.width;n=r>n?r:n;e+=a.height}this.svgElement.setAttribute("height",e),e>this.maxDocumentHeight?this.annotatorContainer.style.height=this.maxDocumentHeight+"px":this.annotatorContainer.style.height="auto";for(i=0;i<this.sentences.length;i++){(a=this.sentences[i]).width=n,a.updateBackground(),a.updateElementsState();var l=e>this.maxDocumentHeight?n-15:n;this.svgElement.setAttribute("width",l)}},t.prototype.onChange=function(t,e,n){this.annotator.removeSelection(),t.changedSentences&&t.changedSentences.length>0&&this.refresh(t.changedSentences),this.sanitizeLog(t),n&&(t.atTime=Math.round((new Date).getTime()/1e3),this.doc.logs.push(t)),!this.annotator.isInViewMode()&&!this.annotator.isReadOnly()&&e&&this.annotatorOnChange&&this.annotatorOnChange(this,t),this.documentHeader.checkButtonsState(),this.annotator.lastModifiedAnnotatorDocument=this},t.prototype.sanitizeLog=function(t){var e=function(t){var n=[];if(t.dependencies&&t.dependencies.length>0)for(var o=0;o<t.dependencies.length;o++){var i=t.dependencies[o];if(i.dependencies&&i.dependencies.length>0){var a=e(i,n);n=n.concat(a)}n.push(i)}return n};if(t.dependencies=e(t),delete t.changedSentences,t.subject&&(t.subject=clone(t.subject),"RELATION"==t.subject.type&&delete t.subject.value.connectors),t.dependencies&&t.dependencies.length>0){for(var n=0;n<t.dependencies.length;n++){var o=t.dependencies[n];delete o.changedSentences,delete o.dependencies,delete o.firedBy,delete o.atTime,o.subject&&(o.subject=clone(o.subject),o.subject.value&&(o.subject.value=clone(o.subject.value),"RELATION"==o.subject.type&&delete o.subject.value.connectors))}t.dependencies=t.dependencies.filter(function(t,e,n){return!t.subject||"RANGE"!=t.subject.type})}},t.prototype.getCollaborationByCollaboratorKey=function(t){if(!this.collaborationByCollaboratorKey&&(this.collaborationByCollaboratorKey=[],this.doc.collaborations))for(var e=0;e<this.doc.collaborations.length;e++){var n=this.doc.collaborations[e],o=this.getCollaboratorKeyByCollaboration(n);this.collaborationByCollaboratorKey[o]=n}return this.collaborationByCollaboratorKey[t]},t.prototype.autoMatch=function(){if(this.doc.collaborations){for(var t={action:"MATCH",firedBy:"AUTOMATCH",dependencies:[],changedSentences:[]},e=this,n=[],o=[],i=[],a=0;a<this.doc.collaborations.length;a++){var s=this.doc.collaborations[a];s.tags.forEach(function(t){var e=t.range+":"+t.label;n[e]?n[e]=n[e]+1:n[e]=1}),s.relations.forEach(function(t){var e=t.from.range+":"+t.from.label+":"+t.to.range+":"+t.to.label+":"+t.label;o[e]?o[e]=o[e]+1:o[e]=1,t.connectors.forEach(function(e){var n=t.from.range+":"+t.from.label+":"+t.to.range+":"+t.to.label+":"+t.label+":"+e;i[n]?i[n]=i[n]+1:i[n]=1})})}for(a=0;a<this.doc.sentences.length;a++){var r=this.doc.sentences[a];this.cleanRange(this.doc,a,0,r.tokens.length-1,!1,t)}Object.keys(n).forEach(function(o){if(n[o]==e.doc.collaborations.length){var i=o.split(":");e.addTag(e.doc,parseInt(i[0]),parseInt(i[1]),parseInt(i[2]),i[3],!1,t)}}),Object.keys(o).forEach(function(n){if(o[n]==e.doc.collaborations.length){var i=n.split(":"),a=e.getTag(e.doc,parseInt(i[0]),parseInt(i[1]),parseInt(i[2])),s=e.getTag(e.doc,parseInt(i[4]),parseInt(i[5]),parseInt(i[6]));e.addRelation(e.doc,a,s,i[8],t)}}),Object.keys(i).forEach(function(n){if(i[n]==e.doc.collaborations.length){var o=n.split(":"),a=e.getTag(e.doc,parseInt(o[0]),parseInt(o[1]),parseInt(o[2])),s=e.getTag(e.doc,parseInt(o[4]),parseInt(o[5]),parseInt(o[6])),r=e.getRelation(e.doc,a,s,o[8]);e.addConnector(e.doc,r,parseInt(o[9]),parseInt(o[10]),parseInt(o[11]),!1,t)}}),this.onChange(t,!0,!0)}},t.prototype.getReverseAction=function(t){var e={dependencies:[],subject:(t=clone(t)).subject};switch(t.action){case"REMOVE":if(e.action="ADD",t.dependencies&&t.dependencies.length>0)if("RANGE"!=t.subject.type){(o=t.dependencies[0]).action="ADD",o.dependencies=[];for(var n=1;n<t.dependencies.length;n++){(r=t.dependencies[n]).action="ADD",o.dependencies.unshift(r)}delete e.dependencies,o.dependencies.unshift(e),e=o}else for(n=0;n<t.dependencies.length;n++){(r=t.dependencies[n]).action="ADD",e.dependencies.unshift(r)}break;case"ADD":if(e.action="REMOVE",t.dependencies&&t.dependencies.length>0){var o;delete e.dependencies,(o=t.dependencies[t.dependencies.length-1]).action="ADD",o.dependencies=[e];for(n=0;n<t.dependencies.length-1;n++){(r=t.dependencies[n]).action="ADD",o.dependencies.push(r)}e=o}break;case"MATCH":case"UNMATCH":if(e.action="MATCH"==t.action?"UNMATCH":"MATCH",t.dependencies&&t.dependencies.length>0){var i=[],a=[],s=[];for(n=0;n<t.dependencies.length;n++){var r;if("ADD"==(r=t.dependencies[n]).action)r.action="REMOVE",i.unshift(r);else if("REMOVE"==r.action)r.action="ADD",a.unshift(r);else if("CHANGE"==r.action){var l=r.subject.value.new,c=r.subject.value.old;r.subject.value.new=c,r.subject.value.old=l,s.unshift(r)}}e.dependencies=i.concat(a).concat(s)}break;case"CHANGE":e.action="CHANGE",e.subject={type:t.subject.type,value:{old:t.subject.value.new,new:t.subject.value.old}};break;case"UNDO":e.action="REDO";break;case"REDO":e.action="UNDO"}return e},t.prototype.applyAction=function(t){var e={changedSentences:[]};if(t.dependencies&&t.dependencies.length>0)for(var n=0;n<t.dependencies.length;n++){var o=this.applyAction(t.dependencies[n]);e.changedSentences=e.changedSentences.concat(o.changedSentences)}switch(t.action){case"ADD":switch(t.subject.type){case"TAG":var i=t.subject.value.range.split(":").map(function(t){return parseInt(t)});o=this.addTag(this.doc,i[0],i[1],i[2],t.subject.value.label,!1,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1);break;case"RELATION":var a=t.subject.value.from.range.split(":").map(function(t){return parseInt(t)}),s=this.getTag(this.doc,a[0],a[1],a[2]),r=t.subject.value.to.range.split(":").map(function(t){return parseInt(t)}),l=this.getTag(this.doc,r[0],r[1],r[2]);o=this.addRelation(this.doc,s,l,t.subject.value.label,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1);break;case"CONNECTOR":a=t.subject.value.from.range.split(":").map(function(t){return parseInt(t)}),s=this.getTag(this.doc,a[0],a[1],a[2]),r=t.subject.value.to.range.split(":").map(function(t){return parseInt(t)}),l=this.getTag(this.doc,r[0],r[1],r[2]);var c=this.getRelation(this.doc,s,l,t.subject.value.label),h=t.subject.value.range.split(":").map(function(t){return parseInt(t)});o=this.addConnector(this.doc,c,h[0],h[1],h[2],!1,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1)}break;case"REMOVE":switch(t.subject.type){case"TAG":i=t.subject.value.range.split(":").map(function(t){return parseInt(t)});var g=this.getTag(this.doc,i[0],i[1],i[2]);o=this.removeTag(this.doc,g,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1);break;case"RELATION":a=t.subject.value.from.range.split(":").map(function(t){return parseInt(t)}),s=this.getTag(this.doc,a[0],a[1],a[2]),r=t.subject.value.to.range.split(":").map(function(t){return parseInt(t)}),l=this.getTag(this.doc,r[0],r[1],r[2]),c=this.getRelation(this.doc,s,l,t.subject.value.label),o=this.removeRelation(this.doc,c,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1);break;case"CONNECTOR":a=t.subject.value.from.range.split(":").map(function(t){return parseInt(t)}),s=this.getTag(this.doc,a[0],a[1],a[2]),r=t.subject.value.to.range.split(":").map(function(t){return parseInt(t)}),l=this.getTag(this.doc,r[0],r[1],r[2]),c=this.getRelation(this.doc,s,l,t.subject.value.label),h=t.subject.value.range.split(":").map(function(t){return parseInt(t)});var u=this.getConnector(this.doc,c,h[0],h[1],h[2]);o=this.removeConnector(this.doc,u,{});e.changedSentences=e.changedSentences.concat(o.changedSentences),this.onChange(o,!1,!1)}break;case"MATCH":case"UNMATCH":break;case"CHANGE":switch(t.subject.type){case"STATUS":this.doc.status=t.subject.value.new,this.documentHeader.updateStatus(this.doc.status)}break;case"UNDO":break;case"REDO":o=this.applyAction(t.subject);e.changedSentences=e.changedSentences.concat(o.changedSentences)}return e.changedSentences=ArrayUtil.getUnique(e.changedSentences),e},t.prototype.getActionToUndo=function(){for(var t=0,e=this.doc.logs.length-1;e>=0;e--){var n=this.doc.logs[e];if("OPEN"!=n.action&&"UNDO"!=n.action&&"REDO"!=n.action){if(0==t)return clone(n);t--}else"UNDO"!=n.action&&"REDO"!=n.action||(t="UNDO"==n.action?t+1:t-1)}},t.prototype.getActionToRedo=function(){for(var t=0,e=this.doc.logs.length-1;e>=0;e--){var n=this.doc.logs[e];if("OPEN"!=n.action&&"UNDO"!=n.action&&"REDO"!=n.action){if(1==t)return clone(n);if(0==t)break;t--}else"UNDO"!=n.action&&"REDO"!=n.action||(t="UNDO"==n.action?t+1:t-1)}},t.prototype.canUndo=function(){return!!this.getActionToUndo()},t.prototype.canRedo=function(){return!!this.getActionToRedo()},t.prototype.undo=function(t,e,n){var o=this.getActionToUndo();if(o){var i={action:"UNDO",firedBy:t?"SHORTCUT":"DEFAULT",dependencies:[],changedSentences:[]},a=this.getReverseAction(o);this.applyAction(a),a.subject?i.dependencies.push(a):i.dependencies=a.dependencies,i.subject={subject:o.subject,action:o.action},this.onChange(i,e,n)}},t.prototype.redo=function(t){var e=this.getActionToRedo();if(e){var n={action:"REDO",firedBy:t?"SHORTCUT":"DEFAULT",dependencies:[],changedSentences:[]};this.applyAction(e),e.subject?n.dependencies.push(e):n.dependencies=e.dependencies,n.subject={subject:e.subject,action:e.action},this.onChange(n,!0,!0)}},t.prototype.changeComments=function(t){var e={action:"CHANGE",subject:{type:"COMMENTS",value:{new:t,old:this.doc.comments}}};this.doc.comments=t,this.onChange(e,!0,!1)},t}()),Annotator=function(){function t(t,e,n){this.container=t,this.documents=e,this.config=n||{},this.mouseX=0,this.mouseY=0,this.lastTag=null,this.lastFromTag=null,this.preventKeyEvents=!1,this.init()}return t.prototype.init=function(){this.fixConfig(),this.createStyle();var t=this;this.contextMenu=new ContextMenu(this.container),this.dialog=new Dialog(this.container),window.addEventListener("click",function(e){var n=null!=(e=e||window.event).target?e.target:e.srcElement,o=!n.annotatorElement||n.annotatorElement.documentAnnotator.annotator!=t;n.itemValue||!o&&(o||2==e.button)||t.contextMenu.close(),"annotatorjs-pointable annotatorjs-unselectable"==n.className||t.dialog.isMouseOverDialog||t.dialog.close()}),this.container.addEventListener("mousemove",function(e){e=e||window.event,t.mouseX=e.clientX,t.mouseY=e.clientY});var e=[t.config.hotkeys.relation,t.config.hotkeys.connect,t.config.hotkeys.remove,t.config.hotkeys.tag,t.config.hotkeys.undo,t.config.hotkeys.redo];this.container.addEventListener("keydown",function(n){if(!t.preventKeyEvents&&(t.isInAnnotationMode()||t.isInValidationMode())&&t.isMouseInsideAnnotator()&&-1!=e.indexOf(n.keyCode)&&n.keyCode!=t.config.hotkeys.relation){var o=t.getSelection();if(t.isInAnnotationMode()&&o&&o.anchor&&o.focus&&o.anchor.sentence.key==o.focus.sentence.key&&o.anchor.documentAnnotator&&o.focus.documentAnnotator&&o.anchor.documentAnnotator==o.focus.documentAnnotator){var i=o.anchor.sentence,a=o.anchor.documentAnnotator,s=Math.min(o.anchor.index,o.focus.index),r=Math.max(o.anchor.index,o.focus.index);o.anchor.index==s?o.anchor:o.focus,o.anchor.index==r?o.anchor:o.focus;switch(n.keyCode){case t.config.hotkeys.connect:a.startRelationshipMode(a.doc,i.key,s,r,{firedBy:"SHORTCUT"});break;case t.config.hotkeys.remove:a.onChange(a.cleanRange(a.doc,i.key,s,r,!0,{firedBy:"SHORTCUT"}),!0,!0);break;case t.config.hotkeys.tag:t.lastTag&&a.onChange(a.addTag(a.doc,i.key,s,r,t.lastTag.input.label,!0,{firedBy:"SHORTCUT"}),!0,!0)}}else if(t.lastModifiedAnnotatorDocument)switch(n.keyCode){case t.config.hotkeys.undo:t.lastModifiedAnnotatorDocument.undo(!0,!0,!0);break;case t.config.hotkeys.redo:t.lastModifiedAnnotatorDocument.redo(!0,!0,!0)}}}),this.documents.constructor!==Array&&(this.documents=[this.documents]),this.onChange=function(e,n){t.updateSize(!0),t.config.onChange&&t.config.onChange(e.doc,n,function(){e.undo()})},this.documentAnnotators=[];for(var n=this.container.offsetWidth,o=0;o<this.documents.length;o++){var i=this.documents[o],a=document.createElement("div");a.style.border="1px solid #D2D2D2",a.style.width=n+"px",this.container.appendChild(a);var s=new DocumentAnnotator(this,a,this.contextMenu,this.config.entities,this.config.status,i,this.onChange,this.config.maxDocumentHeight);s.init(),this.documentAnnotators.push(s)}this.updateSize()},t.prototype.fixConfig=function(){this.config.mode&&-1!=["annotation","validation","view"].indexOf(this.config.mode)||(this.config.mode="annotation"),void 0==this.config.strictMode&&(this.config.strictMode=!1),void 0==this.config.showIndex&&(this.config.showIndex=!0),void 0==this.config.showMetadata&&(this.config.showMetadata=!0),void 0==this.config.showComments&&(this.config.showComments=!0),this.config.hotkeys||(this.config.hotkeys={}),this.config.hotkeys.connect||(this.config.hotkeys.connect=67),this.config.hotkeys.remove||(this.config.hotkeys.remove=82),this.config.hotkeys.tag||(this.config.hotkeys.tag=84),this.config.hotkeys.undo||(this.config.hotkeys.undo=90),this.config.hotkeys.redo||(this.config.hotkeys.redo=89),this.config.style||(this.config.style={}),this.config.style.font||(this.config.style.font={}),this.config.style.font.family||(this.config.style.font.family="Arial"),this.config.style.font.color||(this.config.style.font.color={}),this.config.style.font.color.default||(this.config.style.font.color.default="#000000"),this.config.style.font.color.active||(this.config.style.font.color.active="#000000"),this.config.style.font.color.inactive||(this.config.style.font.color.inactive="#000000"),this.config.style.font.color.highlight||(this.config.style.font.color.highlight="#000000"),this.config.style.margin||(this.config.style.margin={}),this.config.style.margin.default||(this.config.style.margin.default=5),this.config.style.padding||(this.config.style.padding={}),this.config.style.padding.interrelation||(this.config.style.padding.interrelation=40),this.config.style.opacity||(this.config.style.opacity={}),this.config.style.opacity.default||(this.config.style.opacity.default=1),this.config.style.color||(this.config.style.color={}),this.config.style.color.primary||(this.config.style.color.primary={}),this.config.style.color.primary.default||(this.config.style.color.primary.default="#FFDB38"),this.config.style.color.primary.active||(this.config.style.color.primary.active="#3E88DD"),this.config.style.color.primary.inactive||(this.config.style.color.primary.inactive="#8E8E8E"),this.config.style.color.primary.highlight||(this.config.style.color.primary.highlight="#4AB921"),this.config.style.color.primary.light||(this.config.style.color.primary.light="#b3ec9d"),this.config.style.color.secondary||(this.config.style.color.secondary={}),this.config.style.color.secondary.default||(this.config.style.color.secondary.default="#F9EDBE"),this.config.style.color.secondary.active||(this.config.style.color.secondary.active="#95B9E2"),this.config.style.color.secondary.inactive||(this.config.style.color.secondary.inactive="#BfBfBf"),this.config.style.color.success||(this.config.style.color.success={}),this.config.style.color.success.default||(this.config.style.color.success.default="#138713"),this.config.style.header||(this.config.style.header={}),this.config.style.header.font||(this.config.style.header.font={}),this.config.style.header.font.size||(this.config.style.header.font.size=12),this.config.style.header.color||(this.config.style.header.color={}),this.config.style.header.color.background||(this.config.style.header.color.background="#D2D2D2"),this.config.style.header.color.action||(this.config.style.header.color.action="#FFFFFF"),this.config.style.header.color.actionBackground||(this.config.style.header.color.actionBackground={}),this.config.style.header.color.actionBackground.enabled||(this.config.style.header.color.actionBackground.enabled="#3169E8"),this.config.style.header.color.actionBackground.disabled||(this.config.style.header.color.actionBackground.disabled="#A7BFF7"),this.config.style.token||(this.config.style.token={}),this.config.style.token.font||(this.config.style.token.font={}),this.config.style.token.font.size||(this.config.style.token.font.size=13),this.config.style.token.font.color||(this.config.style.token.font.color={}),this.config.style.token.font.color.validation||(this.config.style.token.font.color.validation="#000000"),this.config.style.sentence||(this.config.style.sentence={}),this.config.style.sentence.index||(this.config.style.sentence.index={}),this.config.style.sentence.index.font||(this.config.style.sentence.index.font={}),this.config.style.sentence.index.font.size||(this.config.style.sentence.index.font.size=10),this.config.style.sentence.index.color||(this.config.style.sentence.index.color={}),this.config.style.sentence.index.color.background||(this.config.style.sentence.index.color.background="#D2D2D2"),this.config.style.sentence.index.color.diffBackground||(this.config.style.sentence.index.color.diffBackground="#FF4C4C"),this.config.style.sentence.index.width||(this.config.style.sentence.index.width=50),this.config.style.sentence.color||(this.config.style.sentence.color={}),this.config.style.sentence.color.background||(this.config.style.sentence.color.background={}),this.config.style.sentence.color.background.even||(this.config.style.sentence.color.background.even="#F6F6F6"),this.config.style.sentence.color.background.odd||(this.config.style.sentence.color.background.odd="#FFFFFF"),this.config.style.tag||(this.config.style.tag={}),this.config.style.tag.font||(this.config.style.tag.font={}),this.config.style.tag.font.size||(this.config.style.tag.font.size=12),this.config.style.relation||(this.config.style.relation={}),this.config.style.relation.text||(this.config.style.relation.text={}),this.config.style.relation.text.font||(this.config.style.relation.text.font={}),this.config.style.relation.text.font.size||(this.config.style.relation.text.font.size=12),this.config.style.relation.arc||(this.config.style.relation.arc={}),this.config.style.relation.arc.color||(this.config.style.relation.arc.color={}),this.config.style.relation.arc.color.fill||(this.config.style.relation.arc.color.fill="#000000"),this.config.style.relation.arc.color.valid||(this.config.style.relation.arc.color.valid="#138713"),this.config.style.relation.arc.color.invalid||(this.config.style.relation.arc.color.invalid="#FF1A21"),this.config.style.relation.arc.color.highlight||(this.config.style.relation.arc.color.highlight="#138713"),this.config.style.relation.level||(this.config.style.relation.level={}),this.config.style.relation.level.height||(this.config.style.relation.level.height=10),this.config.style.relation.margin||(this.config.style.relation.margin={}),this.config.style.connector||(this.config.style.connector={}),this.config.style.connector.arc||(this.config.style.connector.arc={}),this.config.style.connector.arc.color||(this.config.style.connector.arc.color={}),this.config.style.connector.arc.color.fill||(this.config.style.connector.arc.color.fill="#6a6a6a"),this.config.style.connector.arc.color.valid||(this.config.style.connector.arc.color.valid="#138713"),this.config.style.connector.arc.color.invalid||(this.config.style.connector.arc.color.invalid="#FF1A21"),this.config.style.connector.arc.color.highlight||(this.config.style.connector.arc.color.highlight="#138713"),this.config.style.contextMenu||(this.config.style.contextMenu={}),this.config.style.contextMenu.color||(this.config.style.contextMenu.color={}),this.config.style.contextMenu.color.background||(this.config.style.contextMenu.color.background="#FFFFFF"),this.config.style.contextMenu.color.highlight||(this.config.style.contextMenu.color.highlight="#CFD1D0"),this.config.style.contextMenu.color.border||(this.config.style.contextMenu.color.border="#B9BABA"),this.config.style.contextMenu.font||(this.config.style.contextMenu.font={}),this.config.style.contextMenu.font.size||(this.config.style.contextMenu.font.size=12)},t.prototype.createStyle=function(){if(!(o=document.getElementById("annotator-style"))){var t=[{selector:".annotatorjs-unselectable",rules:["-moz-user-select: -moz-none","-khtml-user-select: none","-webkit-user-select: none","-ms-user-select: none","user-select: none"]},{selector:".annotatorjs-selectable",rules:["-moz-user-select: text","-khtml-user-select: text","-webkit-user-select: text","-ms-user-select: text","user-select: text","cursor: text"]},{selector:".annotatorjs-pointable",rules:["cursor: pointer"]},{selector:".annotatorjs-token",rules:["font-size: "+this.config.style.token.font.size+"px"]},{selector:".annotatorjs-contextmenu",rules:["display: none","position: fixed","background-color:"+this.config.style.contextMenu.color.background,"border: 1px solid"+this.config.style.contextMenu.color.border,"cursor:pointer","padding:5px 2px","color:#000000","z-index:99999","font-size:12px"]},{selector:".annotatorjs-dialog",rules:["display: none","position: fixed","background-color:"+this.config.style.contextMenu.color.background,"border: 1px solid"+this.config.style.contextMenu.color.border,"padding:5px 2px","color:#000000","z-index:99999","font-size:12px","overflow: auto"]},{selector:".annotatorjs-dialog textarea",rules:["padding: 10px","font-family: monospace","font-size: 10px","line-height: 11px"]},{selector:".annotatorjs-contextmenu .contextmenu-item",rules:["font-size:"+this.config.style.contextMenu.font.size+"px","padding:4px 15px 4px 4px","margin: 4px"]},{selector:".annotatorjs-contextmenu .contextmenu-item.active",rules:["background-color:"+this.config.style.contextMenu.color.highlight]}],e="",n=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");e="";t.forEach(function(t){e+=t.selector+"{"+t.rules.join(";")+"}"}),o.type="text/css",o.id="annotatorjs-style",o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e)),n.appendChild(o)}},t.prototype.isInAnnotationMode=function(){return"annotation"==this.config.mode},t.prototype.isInValidationMode=function(){return"validation"==this.config.mode},t.prototype.isInViewMode=function(){return"view"==this.config.mode},t.prototype.isReadOnly=function(){return!!this.config.readOnly},t.prototype.isMouseInsideAnnotator=function(){return this.mouseX>this.container.getBoundingClientRect().left&&this.mouseX<this.container.getBoundingClientRect().right&&this.mouseY>this.container.getBoundingClientRect().top&&this.mouseY<this.container.getBoundingClientRect().bottom},t.prototype.getSelection=function(){if(window.getSelection&&window.getSelection().toString()){var t=window.getSelection().toString(),e=window.getSelection().anchorNode,n=window.getSelection().focusNode,o=null,i=null;if(e&&"#text"==e.nodeName&&(o=e.parentNode.annotatorElement),n&&"#text"==n.nodeName&&(i=n.parentNode.annotatorElement),null==o&&null==i)return{anchor:null,focus:null,text:t};var a=function(e){for(var n=e.sentence.tokens,o=(e.sentence.key,e.key),i=null,a="",s=o;s>=0;s--)if(!n[s].connector&&-1!=(a=n[s].svgElement.innerHTML+a).indexOf(t)){i=s;break}if(null==i){a="";for(s=o;s<n.length;s++)if(!n[s].connector&&-1!=(a+=n[s].svgElement.innerHTML).indexOf(t)){i=s;break}}if(null!=i)return n[i]};return null==i?i=a(o):null==o&&(o=a(i)),{anchor:o,focus:i,text:t}}},t.prototype.removeSelection=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},t.prototype.updateSize=function(t){for(var e=0;e<this.documentAnnotators.length;e++){this.documentAnnotators[e].container.offsetHeight}this.container.style["font-family"]=this.config.style.font.family,this.container.style["line-height"]="normal",t&&this.config.onResize&&this.config.onResize()},t}(),render=function(t,e,n,o,i,a){for(var s=document.getElementById(t);s.firstChild;)s.removeChild(s.firstChild);var r=document.createElement("div");r.setAttribute("tabindex","-1"),s.appendChild(r);new Annotator(r,e,n,o,i,a)};window.AnnotatorJS={render:render};